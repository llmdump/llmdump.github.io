<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Dump</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  <script type="module">
  try {
    const { Octokit } = await import("https://esm.sh/@octokit/core");
    window.Octokit = Octokit;
  } catch(e) {
    console.warn('Octokit failed to load, authentication will not work');
    window.Octokit = class MockOctokit { constructor() {} };
  }
  </script>
  <script>
  // Fallback for marked.js if CDN fails
  if (typeof marked === 'undefined') {
    window.marked = {
      parse: function(text) { return text.replace(/\n/g, '<br>'); },
      setOptions: function() {}
    };
  }
  // Fallback for highlight.js if CDN fails  
  if (typeof hljs === 'undefined') {
    window.hljs = {
      highlightElement: function() {},
      configure: function() {}
    };
  }
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.0/github-markdown-dark.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop stop-color='%236366f1'/%3E%3Cstop offset='55%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%230ea5e9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='24' ry='24' width='100' height='100' fill='url(%23g)'/%3E%3Cpath fill='%23fff' fill-opacity='.95' d='M50 20 20 35l30 15 30-15L50 20Zm0 15-30 15 30 15 30-15-30-15Zm0 15-30 15 30 15 30-15-30-15Z'/%3E%3C/svg%3E" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }

    .glass {
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(12px);
      border-radius: 16px;
    }

    .glass-sidebar {
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(12px);
      border-radius: 0;
    }

    .glass-sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 2px;
      height: 100%;
      background: linear-gradient(180deg,
        rgba(99, 102, 241, 0) 0%,
        rgba(99, 102, 241, 0.8) 50%,
        rgba(99, 102, 241, 0) 100%);
    }

    .glass-textbox {
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(99,102,241,0.15);
    }

    .glass-textbox::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg,
        rgba(99, 102, 241, 0) 0%,
        rgba(99, 102, 241, 0.8) 50%,
        rgba(99, 102, 241, 0) 100%);
    }

    .glass-textbox::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center bottom,
        rgba(99, 102, 241, 0.12) 0%,
        rgba(139, 92, 246, 0.08) 35%,
        transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    .glass-textbox:focus-within {
      border-color: rgba(139,92,246,0.55);
      outline: none;
    }

    .glass-textbox textarea:focus {
      outline: none;
    }

    /* Message styling */
    .user-bubble {
      max-width: 85%;
      margin: 0 0 16px auto;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.9), rgba(124, 58, 237, 0.8)) !important;
      border-radius: 18px;
      border-bottom-right-radius: 4px;
      padding: 12px 16px;
      position: relative;
      word-wrap: break-word;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 102, 241, 0.3);
      animation: fadeIn 0.3s ease-out;
      width: fit-content;
    }

    .assistant-response {
      margin: 0 0 20px 0;
      padding: 16px 20px;
      position: relative;
      word-wrap: break-word;
      max-width: 85%;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      animation: fadeIn 0.3s ease-out;
    }

    .assistant-response .markdown-body {
      background: transparent;
      color: #e2e8f0;
      padding: 0;
      margin: 0;
    }
    .markdown-body.markdown-body { /* The repetition is to increase specificity and override the default styles*/
      background-color: transparent;
      color: #e2e8f0;
      padding: 0;
      margin: 0;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .assistant-response.streaming::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(110deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05), rgba(14,165,233,0.08));
      opacity: 0.35;
      pointer-events: none;
      animation: shimmer 4s linear infinite;
      background-size: 200% 200%;
    }

    @keyframes shimmer {
      0% { background-position: 0 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }

    .message-actions {
      position: absolute;
      top: 8px;
      right: 12px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 20;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 6px;
      padding: 6px;
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    /* New CSS for inline editing and branches */
    .user-bubble:hover .message-actions,
    .assistant-response:hover .message-actions {
      opacity: 1;
    }

    /* New inline editing and branching system */
    .message-content {
      width: 100%;
    }

    .message-bottom-actions {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .branch-navigation {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: rgba(148, 163, 184, 0.7);
    }

    .branch-indicator {
      font-weight: 500;
    }

    .branch-buttons {
      display: flex;
      gap: 4px;
    }

    .branch-btn {
      padding: 2px 6px;
      font-size: 11px;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: rgba(148, 163, 184, 0.8);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 20px;
      text-align: center;
    }

    .branch-btn:hover {
      background: rgba(99, 102, 241, 0.2);
      color: #e2e8f0;
      border-color: rgba(99, 102, 241, 0.5);
    }

    .branch-btn.active {
      background: rgba(99, 102, 241, 0.3);
      color: white;
      border-color: rgba(99, 102, 241, 0.6);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .bottom-action-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      font-size: 11px;
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: rgba(148, 163, 184, 0.8);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.7;
    }

    .bottom-action-btn:hover {
      background: rgba(99, 102, 241, 0.2);
      color: #e2e8f0;
      border-color: rgba(99, 102, 241, 0.4);
      opacity: 1;
    }

    .bottom-action-btn svg {
      flex-shrink: 0;
    }

    /* Inline editing styles */
    .message-editing {
      position: relative;
    }

    .inline-edit-container {
      position: relative;
      margin: 0;
      background: transparent;
    }

    .inline-edit-textarea {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      color: inherit;
      padding: 0;
      margin: 0;
      overflow: hidden;
      min-height: 1.5em;
    }

    .inline-edit-actions {
      position: absolute;
      bottom: -35px;
      right: 0;
      display: flex;
      gap: 8px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 8px;
      padding: 6px;
      z-index: 100;
    }

    .inline-edit-btn {
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .inline-edit-btn.save {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.4);
      color: #10b981;
    }

    .inline-edit-btn.save:hover {
      background: rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.6);
    }

    .inline-edit-btn.cancel {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
      color: #ef4444;
    }

    .inline-edit-btn.cancel:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.6);
    }
    .edit-textarea {
      font-family: inherit !important;
      font-size: inherit !important;
      line-height: inherit !important;
    }

    .edit-btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    /* Branch navigation styles */
    .branch-navigation {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      border: 1px solid rgba(99, 102, 241, 0.2);
      font-size: 12px;
    }

    .branch-btn {
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #94a3b8;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .branch-btn:hover {
      background: rgba(99, 102, 241, 0.3);
      color: #e2e8f0;
    }

    .branch-btn.active {
      background: rgba(99, 102, 241, 0.4);
      color: #ffffff;
      border-color: rgba(99, 102, 241, 0.6);
    }

    .branch-indicator {
      color: #64748b;
      font-size: 11px;
    }

    /* Action buttons repositioning */
    .message-content {
      margin-bottom: 32px;
    }

    .message-bottom-actions {
      position: absolute;
      bottom: -28px;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.2s;
      padding: 4px 0;
    }

    .user-bubble:hover .message-bottom-actions,
    .assistant-response:hover .message-bottom-actions {
      opacity: 1;
    }

    .action-buttons {
      display: flex;
      gap: 6px;
    }

    .bottom-action-btn {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #94a3b8;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      backdrop-filter: blur(10px);
    }

    .bottom-action-btn:hover {
      background: rgba(99, 102, 241, 0.2);
      color: #e2e8f0;
      border-color: rgba(99, 102, 241, 0.5);
    }


    .user-bubble:hover .message-actions,
    .assistant-response:hover .message-actions {
      opacity: 1;
    }

    .action-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: rgba(99, 102, 241, 0.3);
      color: #e2e8f0;
      border-color: rgba(99, 102, 241, 0.5);
    }

    /* Stop button styling */
    .stop-btn {
        border: 2px solid #ef4444 !important;
        color: #ef4444 !important;
        background: rgba(0, 0, 0, 0) !important;
        width: 8px !important;
        height: 8px !important;
        border-radius: 6px !important;
        align-content: center;
    }

    .stop-btn:hover {
      color: #fca5a5 !important;
    }

    /* Profile menu positioning */
    .profile-menu {
      position: fixed;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      padding: 8px;
      z-index: 1000;
      min-width: 180px;
      border: 1px solid rgba(99, 102, 241, 0.2);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.2s ease-out;
      pointer-events: none;
    }

    .profile-menu:not(.hidden) {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .profile-menu button {
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      background: transparent;
      border: none;
      color: #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .profile-menu button:last-child {
      margin-bottom: 0;
    }

    .profile-menu button:hover {
      background: rgba(99, 102, 241, 0.2);
      color: #fff;
      transform: translateX(4px);
    }

    .profile-menu button#signoutBtn {
      color: #ef4444;
    }

    .profile-menu button#signoutBtn:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .blob {
      position: fixed;
      border-radius: 50%;
      filter: blur(80px);
      z-index: -1;
    }

    .chat-bubble {
      max-width: 85%;
      border-radius: 18px;
      padding: 10px 14px;
      margin-bottom: 12px;
      position: relative;
      animation: fadeIn 0.2s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tooltip {
      position: relative;
      cursor: help;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #1e293b;
      color: #e2e8f0;
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      border: 1px solid #334155;
      font-size: 12px;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .send-icon {
      width: 20px;
      height: 20px;
    }

    /* Custom dropdown styles */
    .custom-dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .dropdown-selected {
      background: transparent;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
      transition: background-color 0.2s ease;
      position: relative;
    }

    .dropdown-selected::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%) rotate(90deg);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid #94a3b8;
      transition: transform 0.2s ease;
    }

    .dropdown-selected.active::after {
      transform: translateY(-50%) rotate(270deg);
    }

    .dropdown-selected.active, .dropdown-selected:hover {
      background: rgba(99, 102, 241, 0.1);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.3);
      width: 100%;
      border-radius: 8px;
      z-index: 99999;
      top: 100%;
      left: 0;
      margin-top: 4px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      animation: dropdownFade 0.2s ease-out;
      max-height: 400px;
      overflow-y: auto;
    }

    @keyframes dropdownFade {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-content.show {
      display: block;
    }

    .dropdown-search-container {
      display: flex;
      align-items: center;
      padding: 10px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 8px 8px 0 0;
    }

    .search-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      fill: #94a3b8;
    }

    .dropdown-search {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      outline: none;
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background-color 0.2s ease;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: rgba(79, 70, 229, 0.2);
    }

    .model-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      flex-shrink: 0;
    }

    .model-info {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }

    .model-limits {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 120px;
      flex-shrink: 0;
      font-size: 11px;
    }

    .rate-limit-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      white-space: nowrap;
    }

    .rate-limit-tier {
      background: rgba(99, 102, 241, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .rate-limit-tokens {
      font-size: 10px;
      color: #94a3b8;
      line-height: 1.2;
    }

    .profile-menu {
      position: fixed;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 8px;
      padding: 8px;
      z-index: 1000;
      min-width: 160px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .assistant-block {
      max-width: 800px;
      margin: 0 auto 20px auto;
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 16px;
      padding: 16px 20px;
      position: relative;
    }

    .assistant-block.streaming::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(110deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.05), rgba(14, 165, 233, 0.08));
      opacity: 0.4;
      pointer-events: none;
      animation: shimmer 3s linear infinite;
      background-size: 200% 200%;
    }

    @keyframes shimmer {
      0% { background-position: 0 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }

    .user-block {
      max-width: 800px;
      margin: 0 auto 16px auto;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(124, 58, 237, 0.2));
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 16px;
      padding: 14px 18px;
      position: relative;
    }

    .block-actions {
      position: absolute;
      top: 8px;
      right: 12px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .assistant-block:hover .block-actions,
    .user-block:hover .block-actions {
      opacity: 1;
    }

    /* Enhanced animations and effects */
    .assistant-bubble {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      margin-right: auto;
      align-self: flex-start;
      position: relative;
    }

    .action-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: rgba(79, 70, 229, 0.3);
      color: #e2e8f0;
    }

    .action-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Improved thinking indicator */
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .thinking-dots {
      display: inline-flex;
      gap: 2px;
    }

    .thinking-dots span {
      width: 4px;
      height: 4px;
      background: #94a3b8;
      border-radius: 50%;
      animation: pulse 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    /* System prompt styling */
    .system-prompt-container {
      margin-bottom: 4px;
    }

    .system-prompt-toggle {
      font-size: 12px;
      color: #64748b;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(30, 41, 59, 0.3);
      margin-bottom: 8px;
      display: inline-block;
    }

    .system-prompt-toggle:hover {
      background: rgba(30, 41, 59, 0.5);
    }

    .system-prompt-editor {
      display: none;
      margin-bottom: 12px;
    }

    .system-prompt-editor.show {
      display: block;
    }

    .system-prompt-textarea {
      width: 100%;
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 8px;
      padding: 8px;
      color: #e2e8f0;
      font-size: 13px;
      resize: vertical;
      min-height: 80px;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
      body {
        overflow: auto;
      }

      #chatPage {
        flex-direction: column;
        height: 100vh;
      }

      #sidebar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9998;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
      }

      #sidebar.mobile-open {
        display: flex;
        transform: translateX(0);
      }

      .mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    /* Additional CSS for new features */
    .chat-history-item.focused { background: rgba(79,70,229,0.4)!important; outline: 1px solid #6366f1; }

    /* Inline editing and branching styles */
    .inline-edit-container {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      margin: 0;
      width: 100%;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
      resize: none;
      overflow: hidden;
      outline: none;
      min-height: 1.5em;
      line-height: 1.5;
    }

    .inline-edit-container:focus {
      background: rgba(99, 102, 241, 0.1);
      border-radius: 8px;
      padding: 8px;
      outline: 2px solid rgba(99, 102, 241, 0.5);
    }

    .edit-controls {
      position: absolute;
      bottom: -35px;
      right: 0;
      display: flex;
      gap: 8px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 8px;
      padding: 4px;
      z-index: 30;
    }

    .edit-btn {
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #e2e8f0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .edit-btn:hover {
      background: rgba(99, 102, 241, 0.4);
      color: #fff;
    }

    .edit-btn.save {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.3);
      color: #10b981;
    }

    .edit-btn.save:hover {
      background: rgba(16, 185, 129, 0.4);
      color: #fff;
    }

    .edit-btn.cancel {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .edit-btn.cancel:hover {
      background: rgba(239, 68, 68, 0.4);
      color: #fff;
    }

    /* Bottom action buttons */
    .message-bottom-actions {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Message content wrapper */
    .message-content {
      position: relative;
    }
        background: rgba(30, 41, 59, 0.4);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        gap: 12px;
      }

      .mobile-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
      }

      .mobile-model-selector {
        min-width: 120px;
        max-width: 150px;
      }

      .dropdown-content {
        width: calc(100vw - 32px);
        left: 16px;
        right: 16px;
        max-width: none;
        max-height: 60vh;
        overflow-y: auto;
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(99, 102, 241, 0.4);
        z-index: 9999;
      }

      .dropdown-search-container {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(30, 41, 59, 0.9);
        backdrop-filter: blur(20px);
      }

      .chat-bubble {
        max-width: 95%;
      }

      .user-bubble, .assistant-response {
        max-width: 92%;
      }

      .mobile-model-selector {
        min-width: 120px;
        max-width: 140px;
      }

      .action-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
        min-height: 28px;
      }

      .thinking-indicator {
        font-size: 12px;
        padding: 6px 10px;
      }

      /* Hide desktop header on mobile */
      .desktop-header {
        display: none;
      }
    }

    @media (min-width: 769px) {
      .mobile-header {
        display: none;
      }

      .mobile-hamburger {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .glass {
        border-radius: 12px;
      }

      .glass-textbox {
        border-radius: 12px;
      }

      .dropdown-content {
        width: calc(100vw - 32px);
        max-width: none;
      }

      .model-info span {
        font-size: 14px;
      }

      .model-limits span {
        font-size: 11px;
      }
    }

    /* Additional CSS for new features */
    .chat-history-item.focused { background: rgba(79,70,229,0.4)!important; outline: 1px solid #6366f1; }

    .chat-history-edit-toggle {
      position: relative;
      width: 24px;
      height: 24px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .chat-history-edit-toggle:hover{
      background: rgba(99, 102, 241, 0.4);
      color: #fff;
    }
    .chat-history-edit-toggle.active {     
      background: rgb(60 255 130 / 58%);
      color: #09fff6;
    }



    .sidebar.editing .chat-history-item {
      border: 1px dashed rgba(99, 102, 241, 0.3);
    }

    .sidebar.editing .del-btn {
      opacity: 1 !important;
    }

    .del-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .drag-handle {
      opacity: 0;
      cursor: grab;
      transition: opacity 0.2s;
      margin-right: 8px;
    }

    .sidebar.editing .drag-handle {
      opacity: 1 !important;
    }

    .chat-history-item.dragging {
      opacity: 0.5;
    }

    /* Enhanced codeblock styling */
    .markdown-body pre {
      position: relative !important;
      background: rgba(15, 23, 42, 0.95) !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
      border-radius: 8px !important;
      padding: 0 !important;
      margin: 16px 0 !important;
      overflow: visible !important;
    }

    .markdown-body code {
      background: rgba(15, 23, 42, 0.7) !important;
      color: #e2e8f0 !important;
      padding: 2px 4px !important;
      border-radius: 4px !important;
      font-family: 'Roboto Mono', 'Consolas', 'Monaco', monospace !important;
      font-size: 13px !important;
    }

    .enhanced-codeblock {
      position: relative !important;
      background: rgba(15, 23, 42, 0.95) !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
      border-radius: 8px !important;
      padding: 0 !important;
      margin: 16px 0 !important;
      overflow: visible !important;
    }

    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(30, 41, 59, 0.6);
      border-bottom: 1px solid rgba(99, 102, 241, 0.2);
      padding: 8px 12px;
      font-size: 12px;
      color: #94a3b8;
    }

    .code-language {
      font-weight: 500;
      color: #e2e8f0;
    }

    .code-actions {
      display: flex;
      gap: 6px;
    }

    .code-action-btn {
      background: transparent;
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #94a3b8;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .code-action-btn:hover {
      background: rgba(99, 102, 241, 0.2);
      color: #e2e8f0;
    }

    .code-action-btn.success {
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.5);
    }

    .markdown-body pre code {
      display: block !important;
      padding: 16px !important;
      background: transparent !important;
      color: #e2e8f0 !important;
      font-family: 'Roboto Mono', 'Consolas', 'Monaco', monospace !important;
      font-size: 13px !important;
      line-height: 1.4 !important;
      overflow-x: auto !important;
      white-space: pre !important;
    }

    .code-wrap .markdown-body pre code {
      white-space: pre-wrap !important;
      word-break: break-all !important;
    }

    .logo { display:flex; align-items:center; gap:10px; font-family:'Roboto Mono', monospace; user-select:none; }
    .logo-icon { position:relative; overflow:visible; }
    .logo-icon svg { display:block; width:100%; height:100%; border-radius:inherit; }
    .logo-icon.gradient-bg { border-radius:14px; }
    .logo-icon.gradient-bg.large { border-radius:22px; }
    .logo .logo-word .pre { color:#e2e8f0; opacity:.88; }
    .logo .logo-word .cursor { color:#ffffff; transform:scaleX(.55); font-weight:600; display:inline-block; }
    .logo .logo-word .post { color:#64748b; opacity:.55; }
    .logo.large .logo-word .cursor { transform:scaleX(.55); }
    .bg-blobs { position:fixed; inset:0; pointer-events:none; z-index:-2; overflow:hidden; }
    .bg-blobs .blob { position:absolute; filter:blur(120px); opacity:.55; mix-blend-mode:screen; }
    .bg-blobs .blob.b1 { width:700px; height:700px; top:-250px; left:-180px; background:radial-gradient(circle at 30% 30%, rgba(99,102,241,.8), rgba(99,102,241,0) 65%); }
    .bg-blobs .blob.b3 { width:500px; height:500px; top:40%; left:55%; background:radial-gradient(circle at 50% 50%, rgba(139,92,246,.55), rgba(139,92,246,0) 70%); }
  </style>
</head>
<body class="m-0 p-0">
  <div class="bg-blobs">
    <div class="blob b1"></div>
  </div>

  <!-- Login Page -->
  <div id="loginPage" class="flex flex-col min-h-screen items-center justify-center px-4">
    <div class="logo large center" style="margin-bottom:40px; flex-direction:column; gap:24px;">
      <div style="display:flex; align-items:center; gap:20px;">
        <div class="logo-icon gradient-bg large" style="width:120px; height:120px;">
          <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
            <defs>
              <linearGradient id="lgMain" x1="0" x2="1" y1="0" y2="1">
                <stop stop-color="#6366f1" />
                <stop offset="55%" stop-color="#8b5cf6" />
                <stop offset="100%" stop-color="#0ea5e9" />
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="100" height="100" rx="24" ry="24" fill="url(#lgMain)" />
            <path fill="#fff" fill-opacity=".95" d="M50 20 20 35l30 15 30-15L50 20Zm0 15-30 15 30 15 30-15-30-15Zm0 15-30 15 30 15 30-15-30-15Z" />
          </svg>
        </div>
        <div class="logo-word" style="font-size:52px; line-height:1;">
          <span class="pre">llm</span><span class="cursor">|</span><span class="post">dump</span>
        </div>
      </div>
      <div class="login-subtext">Login to LLM Dump</div>
    </div>

    <div class="glass p-6 w-full max-w-md">
      <button id="githubLogin" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-3 rounded w-full flex items-center justify-center gap-2 mb-4">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        Sign in with GitHub
      </button>

      <div class="flex items-center gap-2 mb-2">
        <p class="text-sm opacity-80">Or, provide a personal access token</p>
        <div class="tooltip">
          <span class="text-xs bg-gray-700 rounded-full w-5 h-5 flex items-center justify-center cursor-help">i</span>
          <span class="tooltiptext">Create a GitHub Personal Access Token with 'models' scope at github.com/settings/tokens</span>
        </div>
      </div>

      <input type="password" id="patToken" class="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-700 mb-3" placeholder="github_pat_..." />
      <button id="usePat" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded w-full flex items-center justify-center gap-2">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
        </svg>
        Use Token
      </button>
    </div>
  </div>

  <!-- Chat Page -->
  <div id="chatPage" class="flex h-screen hidden">
    <!-- Mobile Header -->
    <div class="mobile-header">
      <button class="mobile-hamburger" id="mobileMenuBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <div class="mobile-logo" style="cursor: pointer;" onclick="window.goToHomepage ? window.goToHomepage() : goToHomepage()">
        <div class="logo-icon gradient-bg" style="width:32px; height:32px; border-radius:8px;">
          <svg viewBox="0 0 100 100">
            <defs>
              <linearGradient id="lgMobile" x1="0" x2="1" y1="0" y2="1">
                <stop stop-color="#6366f1" />
                <stop offset="55%" stop-color="#8b5cf6" />
                <stop offset="100%" stop-color="#0ea5e9" />
              </linearGradient>
            </defs>
            <rect width="100" height="100" rx="24" ry="24" fill="url(#lgMobile)" />
            <path fill="#fff" fill-opacity=".95" d="M50 20 20 35l30 15 30-15L50 20Zm0 15-30 15 30 15 30-15-30-15Zm0 15-30 15 30 15 30-15-30-15Z" />
          </svg>
        </div>
        <span style="font-family:'Roboto Mono', monospace; font-size:16px; font-weight:500;">llm|dump</span>
      </div>

      <div class="mobile-model-selector">
        <div class="custom-dropdown">
          <div id="mobileDropdownSelected" class="dropdown-selected">
            <div id="mobileSelectedModelIcon" class="model-icon bg-gray-700 flex items-center justify-center">
              <span style="font-size:10px;">G</span>
            </div>
            <span id="mobileSelectedModelName" style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">GPT</span>
          </div>
          <div id="mobileDropdownContent" class="dropdown-content">
            <div class="dropdown-search-container">
              <svg class="search-icon" viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <input type="text" id="mobileDropdownSearch" class="dropdown-search" placeholder="Search models...">
            </div>
            <div id="mobileDropdownItems"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar (with glass) -->
    <div id="sidebar" class="w-64 glass-sidebar flex flex-col relative">
      <div class="p-4 flex-1">
        <div class="sidebar-logo-wrap">
          <div class="logo small" style="cursor: pointer;" onclick="window.goToHomepage ? window.goToHomepage() : goToHomepage()">
            <div class="logo-icon gradient-bg" style="width:52px; height:52px; border-radius:16px;">
              <svg viewBox="0 0 100 100">
                <defs>
                  <linearGradient id="lgSide" x1="0" x2="1" y1="0" y2="1">
                    <stop stop-color="#6366f1" />
                    <stop offset="55%" stop-color="#8b5cf6" />
                    <stop offset="100%" stop-color="#0ea5e9" />
                  </linearGradient>
                </defs>
                <rect width="100" height="100" rx="24" ry="24" fill="url(#lgSide)" />
                <path fill="#fff" fill-opacity=".95" d="M50 20 20 35l30 15 30-15L50 20Zm0 15-30 15 30 15 30-15-30-15Zm0 15-30 15 30 15 30-15-30-15Z" />
              </svg>
            </div>
            <div class="logo-word" style="font-size:22px;">
              <span class="pre">llm</span><span class="cursor">|</span><span class="post">dump</span>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-4 mt-6">
          <h3 class="font-semibold">Chat History</h3>
          <button id="editChatsBtn" class="chat-history-edit-toggle" title="Edit Chat Order">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
          </button>
        </div>

        <button id="newChat" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-4 rounded-lg mb-4 flex items-center justify-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          New Chat
        </button>

        <div id="chatHistory" class="space-y-2 overflow-y-auto"></div>
      </div>

      <div class="p-4 border-t border-gray-800 mt-auto">
        <button id="userProfile" class="flex items-center gap-3 w-full text-left p-2 hover:bg-gray-800 rounded-lg">
          <div class="bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <span id="usernameDisplay">Account</span>
        </button>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
      <!-- Header (seamless) -->
      <div class="desktop-header p-4 border-b border-gray-800 flex items-center bg-gray-900">
        <div class="flex-1 flex items-center gap-4">
          <div class="custom-dropdown">
            <div id="dropdownSelected" class="dropdown-selected">
              <div id="selectedModelIcon" class="model-icon bg-gray-700 flex items-center justify-center">
                <span>G</span>
              </div>
              <span id="selectedModelName">Select Model</span>
            </div>
            <div id="dropdownContent" class="dropdown-content">
              <div class="dropdown-search-container">
                <svg class="search-icon" viewBox="0 0 24 24">
                  <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input type="text" id="dropdownSearch" class="dropdown-search" placeholder="Search models...">
              </div>
              <div id="dropdownItems"></div>
            </div>
          </div>
          <div id="rateLimitInfo" class="text-sm text-gray-400 flex items-center gap-2"></div>
          <div id="networkStatus" class="text-xs px-2 py-1 rounded bg-red-900/40 text-red-300 hidden"></div>
        </div>
      </div>

      <!-- Chat Box -->
      <div id="chatBox" class="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-gray-900 to-slate-900">
        <div class="max-w-3xl mx-auto">
          <div id="welcomeMessage" class="text-center py-10 text-gray-500">
            <h2 class="text-2xl mb-4">How can I help you today?</h2>
            <p class="text-sm">Start a conversation by typing a message below</p>
          </div>
        </div>
      </div>

      <!-- Input Area (glass textbox only) -->
      <div class="p-4">
        <div class="max-w-3xl mx-auto">
          <!-- System Prompt Section -->
          <div class="system-prompt-container">
            <div class="system-prompt-toggle" id="systemPromptToggle">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              System Prompt
            </div>
            <div class="system-prompt-editor" id="systemPromptEditor">
              <textarea
                id="systemPromptText"
                class="system-prompt-textarea"
                placeholder="Enter system prompt..."
              >You are a helpful AI assistant. Be concise, accurate, and helpful in your responses.</textarea>
            </div>
          </div>
          <!-- Input Textarea -->
          <div class="glass-textbox relative">
            <textarea
              id="messageInput"
              placeholder="Message..."
              class="w-full p-4 pr-12 rounded-lg bg-transparent text-white resize-none"
              rows="1"
              style="min-height: 60px; max-height: 200px;"
            ></textarea>
            <button id="sendBtn" class="absolute right-3 bottom-3 rounded-full p-2">
              <svg class="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
            <button id="stopBtn" class="absolute right-3 bottom-3 rounded p-2 stop-btn">

          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Menu -->
  <div id="profileMenu" class="profile-menu hidden">
    <button id="settingsBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
      Settings
    </button>
    <button id="signoutBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16,17 21,12 16,7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      Sign Out
    </button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="glass p-6 w-full max-w-md relative">
      <button id="closeSettings" class="absolute top-3 right-3 rounded-full p-2">
        <svg class="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>

      <h3 class="text-xl font-bold mb-4">Settings</h3>

      <div class="mb-4">
        <label class="block mb-2">Title Generation Model</label>
        <div class="custom-dropdown">
          <div id="titleDropdownSelected" class="dropdown-selected">
            <div id="titleSelectedModelIcon" class="model-icon bg-gray-700 flex items-center justify-center">
              <span style="font-size:10px;">G</span>
            </div>
            <span id="titleSelectedModelName">GPT-4.1 Mini</span>
          </div>
          <div id="titleDropdownContent" class="dropdown-content">
            <div class="dropdown-search-container">
              <svg class="search-icon" viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <input type="text" id="titleDropdownSearch" class="dropdown-search" placeholder="Search models...">
            </div>
            <div id="titleDropdownItems"></div>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <label class="block mb-2">Edit Personal Access Token</label>
        <input type="password" id="settingsPat" class="w-full p-2 rounded bg-gray-800 border border-gray-700 mb-2" placeholder="github_pat_..." />
        <button id="saveToken" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded w-full">
          Save Token
        </button>
      </div>

      <div class="flex gap-2 mb-4">
        <button id="exportAll" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
          Export All Chats
        </button>
        <button id="importChats" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
          Import Chats
        </button>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    // Backend configuration
    const DEFAULT_API_BASE = 'https://tanjim.ddns.net';
    let API_BASE = (localStorage.getItem('api_base')||DEFAULT_API_BASE||'').trim();
    if(API_BASE.endsWith('/')) API_BASE = API_BASE.slice(0,-1);

    // DOM Elements
    const loginPage = document.getElementById('loginPage');
    const chatPage = document.getElementById('chatPage');
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const chatHistory = document.getElementById('chatHistory');
    const newChatBtn = document.getElementById('newChat');
    const userProfile = document.getElementById('userProfile');
    const profileMenu = document.getElementById('profileMenu');
    const settingsModal = document.getElementById('settingsModal');
    const dropdownSelected = document.getElementById('dropdownSelected');
    const dropdownContent = document.getElementById('dropdownContent');
    const dropdownSearch = document.getElementById('dropdownSearch');
    const dropdownItems = document.getElementById('dropdownItems');
    const rateLimitInfo = document.getElementById('rateLimitInfo');
    const sidebarSettings = document.getElementById('sidebarSettings');

    // Enhanced marked renderer for codeblocks
    const renderer = new marked.Renderer();
    const originalCode = renderer.code;

    renderer.code = function(code, language, escaped) {
      const lang = language || 'text';
      const langDisplay = lang.charAt(0).toUpperCase() + lang.slice(1);
      const codeId = 'code-' + Math.random().toString(36).substr(2, 9);

      // Apply syntax highlighting if hljs is available
      let highlightedCode = escaped ? code : marked.escapeTest(code);
      if (typeof hljs !== 'undefined' && lang !== 'text') {
        try {
          highlightedCode = hljs.highlight(code, { language: lang }).value;
        } catch (e) {
          // Fall back to plain text if language not supported
          highlightedCode = escaped ? code : marked.escapeTest(code);
        }
      }

      const copyIcon = `&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;&lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;&lt;/svg&gt;`;
      const downloadIcon = `&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"&gt;&lt;/path&gt;&lt;polyline points="7,10 12,15 17,10"&gt;&lt;/polyline&gt;&lt;line x1="12" y1="15" x2="12" y2="3"&gt;&lt;/line&gt;&lt;/svg&gt;`;
      const wrapIcon = `&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="6,9 12,15 18,9"&gt;&lt;/polyline&gt;&lt;/svg&gt;`;
      
      return `
        &lt;pre class="enhanced-codeblock"&gt;
          &lt;div class="code-header"&gt;
            &lt;span class="code-language"&gt;${langDisplay}&lt;/span&gt;
            &lt;div class="code-actions"&gt;
              &lt;button class="code-action-btn" onclick="copyCode('${codeId}')" title="Copy code"&gt;
                ${copyIcon}
                Copy
              &lt;/button&gt;
              &lt;button class="code-action-btn" onclick="downloadCode('${codeId}', '${lang}')" title="Download as file"&gt;
                ${downloadIcon}
                Download
              &lt;/button&gt;
              &lt;button class="code-action-btn" onclick="toggleWrap('${codeId}')" title="Toggle line wrap"&gt;
                ${wrapIcon}
                Wrap
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;code id="${codeId}" class="language-${lang}"&gt;${highlightedCode}&lt;/code&gt;
        &lt;/pre&gt;
      `;
    };

    marked.setOptions({ renderer });

    // Codeblock action functions
    window.copyCode = function(codeId) {
      const codeElement = document.getElementById(codeId);
      if (!codeElement) return;

      const code = codeElement.textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = event.target.closest('.code-action-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = `&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="20,6 9,17 4,12"&gt;&lt;/polyline&gt;&lt;/svg&gt;Copied`;
        btn.classList.add('success');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('success');
        }, 2000);
      });
    };

    window.downloadCode = function(codeId, language) {
      const codeElement = document.getElementById(codeId);
      if (!codeElement) return;

      const code = codeElement.textContent;
      const extensions = {
        javascript: 'js', typescript: 'ts', python: 'py',
        java: 'java', cpp: 'cpp', csharp: 'cs',
        php: 'php', ruby: 'rb', go: 'go', rust: 'rs',
        html: 'html', css: 'css', sql: 'sql', json: 'json',
        xml: 'xml', yaml: 'yml', markdown: 'md', shell: 'sh',
        bash: 'sh', powershell: 'ps1', text: 'txt'
      };

      const ext = extensions[language.toLowerCase()] || 'txt';
      const filename = `code.${ext}`;

      const blob = new Blob([code], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    };

    window.toggleWrap = function(codeId) {
      const codeElement = document.getElementById(codeId);
      if (!codeElement) return;

      const pre = codeElement.closest('pre');
      pre.classList.toggle('code-wrap');

      const btn = event.target.closest('.code-action-btn');
      const isWrapped = pre.classList.contains('code-wrap');
      btn.innerHTML = isWrapped ?
        `&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="18,15 12,9 6,15"&gt;&lt;/polyline&gt;&lt;/svg&gt;Unwrap` :
        `&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="6,9 12,15 18,9"&gt;&lt;/polyline&gt;&lt;/svg&gt;Wrap`;
    };

    // State
    let chats = JSON.parse(localStorage.getItem('chat_history') || '[]');
    let currentChatId = null;
    let models = [];
    let currentAbortController = null;

    // Migrate old chats to support branching
    chats.forEach(chat => {
      if (!chat.branches) {
        // Convert linear messages to branched format
        chat.branches = [chat.messages || []];
        chat.currentBranch = 0;
        delete chat.messages; // Remove old format
      }
    });

    // Helper functions
    function loadUserProfile(){
      const token=localStorage.getItem('gh_token');
      if(!token || !token.trim() || token.trim()=="" || token == "") return;
      fetch('https://api.github.com/user',{headers:{Authorization:`Bearer ${token}`}})
        .then(r=> r.ok ? r.json(): Promise.reject())
        .then(u=>{
          if(u.login){ document.getElementById('usernameDisplay').textContent=u.login; }
          if(u.avatar_url){
            const av=userProfile.querySelector('div');
            av.innerHTML=`&lt;img src="${u.avatar_url}&s=80" class="w-8 h-8 rounded-full"/&gt;`;
          }
        }).catch(()=>{});
    }

    function showLoginPage() {
      loginPage?.classList.remove('hidden');
      chatPage?.classList.add('hidden');
    }

    function showChatPage() {
      loginPage?.classList.add('hidden');
      chatPage?.classList.remove('hidden');
    }

    // Auth handlers
    const patInput = document.getElementById('patToken');
    document.getElementById('usePat')?.addEventListener('click', () => {
      const token = patInput.value.trim();
      if (token.startsWith('github_pat_')) {
        const octokit = new Octokit({ auth: token });
        localStorage.setItem('gh_token', token);
        fetchModels();
        loadUserProfile();
        showChatPage();

      } else {
        alert('Invalid token (must start with github_pat_)');
      }
    });

    // Auth init
    const storedToken = localStorage.getItem('gh_token');
    if (storedToken) {
      fetchModels();
      loadUserProfile();
      showChatPage();
    } else {
      showLoginPage();
    }

    // Profile menu
    userProfile?.addEventListener('click', (e) => {
      e.stopPropagation();
      profileMenu?.classList.toggle('hidden');

      if(!profileMenu?.classList.contains('hidden')) {
        const rect = userProfile.getBoundingClientRect();
        profileMenu.style.left = rect.left + 'px';
        profileMenu.style.top = (rect.top - profileMenu.offsetHeight - 8) + 'px';
      }
    });
    document.getElementById('signoutBtn')?.addEventListener('click', () => {
      localStorage.clear(); // Clear all stored data including tokens
      profileMenu?.classList.add('hidden');
      showLoginPage();
    });
    document.getElementById('settingsBtn')?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent closing the menu because of outside click
      profileMenu?.classList.add('hidden');
      settingsModal?.classList.remove('hidden');
    });

    // Outside click
    document.addEventListener('click', (e) => {
      if (profileMenu && !profileMenu.classList.contains('hidden') && !profileMenu.contains(e.target) && e.target !== userProfile) {
        profileMenu.classList.add('hidden');
      }

      // Desktop dropdown
      if (dropdownContent?.classList.contains('show') && !dropdownSelected?.contains(e.target) && !dropdownContent.contains(e.target)) {
        dropdownContent.classList.remove('show');
        dropdownSelected?.classList.remove('active');
      }

      // Title dropdown
      const titleDropdownContent = document.getElementById('titleDropdownContent');
      const titleDropdownSelected = document.getElementById('titleDropdownSelected');
      if (titleDropdownContent?.classList.contains('show') && !titleDropdownSelected?.contains(e.target) && !titleDropdownContent.contains(e.target)) {
        titleDropdownContent.classList.remove('show');
        titleDropdownSelected?.classList.remove('active');
      }

      // Mobile dropdown
      const mobileContent = document.getElementById('mobileDropdownContent');
      const mobileSelected = document.getElementById('mobileDropdownSelected');
      if (mobileContent?.classList.contains('show') && !mobileSelected?.contains(e.target) && !mobileContent.contains(e.target)) {
        mobileContent.classList.remove('show');
        mobileSelected?.classList.remove('active');
      }

      // Mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      if (sidebar?.classList.contains('mobile-open') && !sidebar.contains(e.target) && e.target !== mobileMenuBtn) {
        sidebar.classList.remove('mobile-open');
      }

      if (settingsModal && !settingsModal.classList.contains('hidden')) {
        const glass = settingsModal.querySelector('.glass');
        if (glass && !glass.contains(e.target)) {
          settingsModal.classList.add('hidden');
        }
      }
    });

    // Settings modal
    document.getElementById('closeSettings')?.addEventListener('click', () => settingsModal?.classList.add('hidden'));
    document.getElementById('saveToken')?.addEventListener('click', () => {
      const newToken = document.getElementById('settingsPat').value.trim();
      if (newToken.startsWith('github_pat_')) {
        localStorage.setItem('gh_token', newToken);
        location.reload();
      } else {
        alert('Token must start with github_pat_');
      }
    });
    document.getElementById('exportAll')?.addEventListener('click', () => {
      const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(chats, null, 2));
      const a = document.createElement('a');
      a.href = dataStr; a.download = 'chat_history.json';
      document.body.appendChild(a); a.click(); a.remove();
    });
    document.getElementById('importChats')?.addEventListener('click', () => {
      const input = document.createElement('input'); input.type='file'; input.accept='.json';
      input.onchange = evt => {
        const file = evt.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => { try { const imported = JSON.parse(reader.result); chats = imported; localStorage.setItem('chat_history', JSON.stringify(chats)); location.reload(); } catch { alert('Invalid JSON'); } };
        reader.readAsText(file,'utf-8');
      };
      input.click();
    });

    // ESC close
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') {
        dropdownContent?.classList.remove('show');
        dropdownSelected?.classList.remove('active');
        document.getElementById('titleDropdownContent')?.classList.remove('show');
        document.getElementById('titleDropdownSelected')?.classList.remove('active');
        document.getElementById('mobileDropdownContent')?.classList.remove('show');
        document.getElementById('mobileDropdownSelected')?.classList.remove('active');
        document.getElementById('sidebar')?.classList.remove('mobile-open');
        profileMenu?.classList.add('hidden');
        if (!settingsModal?.classList.contains('hidden')) settingsModal.classList.add('hidden');
      }
    });

    // Model dropdown
    dropdownSelected?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropdownContent?.classList.toggle('show');
      dropdownSelected?.classList.toggle('active');
    });
    dropdownSearch?.addEventListener('input', e => filterModels(e.target.value));

    // Title generation model dropdown
    const titleDropdownSelected = document.getElementById('titleDropdownSelected');
    const titleDropdownContent = document.getElementById('titleDropdownContent');
    const titleDropdownSearch = document.getElementById('titleDropdownSearch');
    const titleDropdownItems = document.getElementById('titleDropdownItems');

    titleDropdownSelected?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      titleDropdownContent?.classList.toggle('show');
      titleDropdownSelected?.classList.toggle('active');
    });

    titleDropdownSearch?.addEventListener('input', e => filterTitleModels(e.target.value));

    function filterTitleModels(query) {
      const q = query.toLowerCase();
      renderTitleDropdownItems(models.filter(m => m.name.toLowerCase().includes(q) || m.publisher.toLowerCase().includes(q)));
    }

    function appendAssistantMessage(content){
      const welcome=document.getElementById('welcomeMessage');
      if(welcome) welcome.remove();

      const response = document.createElement('div');
      response.className = 'assistant-response';
      response.innerHTML = `
        &lt;div class="message-content"&gt;
          &lt;div class="markdown-body"&gt;${marked.parse(content)}&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="message-bottom-actions"&gt;
          &lt;div class="action-buttons"&gt;
            &lt;button class="bottom-action-btn" onclick="regenerateMessage(this)" title="Regenerate"&gt;
              &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                &lt;polyline points="23,4 23,10 17,10"&gt;&lt;/polyline&gt;
                &lt;polyline points="1,20 1,14 7,14"&gt;&lt;/polyline&gt;
                &lt;path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4-4.64,4.36A9,9,0,0,1,3.51,15"&gt;&lt;/path&gt;
              &lt;/svg&gt;
              Regenerate
            &lt;/button&gt;
            &lt;button class="bottom-action-btn" onclick="copyMessage(this)" title="Copy"&gt;
              &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                &lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;
                &lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;
              &lt;/svg&gt;
              Copy
            &lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      `;
      response.dataset.role = 'assistant';
      chatBox.appendChild(response);
      chatBox.scrollTop = chatBox.scrollHeight;

      const chat = chats.find(c => c.id === currentChatId);
      if(chat) {
        // Initialize branches if needed
        if (!chat.branches) {
          chat.branches = [chat.messages || []];
          chat.currentBranch = 0;
          delete chat.messages;
        }

        const currentBranch = chat.branches[chat.currentBranch];
        if(!currentBranch.some(m => m.content === content && m.role === 'assistant')){
          currentBranch.push({role: 'assistant', content});
          localStorage.setItem('chat_history', JSON.stringify(chats));
        }
      }
    }
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="23,4 23,10 17,10"></polyline>
                      <polyline points="1,20 1,14 7,14"></polyline>
                      <path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4-4.64,4.36A9,9,0,0,1,3.51,15"></path>
    window.editMessage = (btn) => {
      const container = btn.closest('.user-bubble, .assistant-response');
      if (!container || container.querySelector('.inline-edit-container')) return;
      
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      
      const messageIndex = parseInt(container.dataset.messageIndex);
      const currentBranch = getCurrentBranch(chat);
      const message = currentBranch[messageIndex];
      if (!message) return;
      
      const messageContent = container.querySelector('.message-content');
      const markdownBody = messageContent.querySelector('.markdown-body');
      const originalText = message.content;
      
      // Create inline edit container
      const editContainer = document.createElement('div');
      editContainer.className = 'inline-edit-container';
      
      // Create textarea with same styling as the message
      const textarea = document.createElement('textarea');
      textarea.className = 'inline-edit-textarea';
      textarea.value = originalText;
      
      // Auto-resize function
      const autoResize = () => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      };
      
      // Create action buttons
      const actionContainer = document.createElement('div');
      actionContainer.className = 'inline-edit-actions';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'inline-edit-btn save';
      saveBtn.innerHTML = `
        &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
          &lt;path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"&gt;&lt;/path&gt;
        &lt;/svg&gt;
        Send
      `;
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'inline-edit-btn cancel';
      cancelBtn.innerHTML = `
        &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
          &lt;path d="M18 6L6 18"&gt;&lt;/path&gt;
          &lt;path d="M6 6l12 12"&gt;&lt;/path&gt;
        &lt;/svg&gt;
        Cancel
      `;
      
      // Event handlers
      const saveEdit = () => {
        const newContent = textarea.value.trim();
        if (!newContent) return;
        
        // Create new branch with edited message
        const newBranchIndex = createNewBranch(chat, messageIndex, {
          role: message.role,
          content: newContent
        });
        
        // Switch to new branch and reload
        switchToBranch(chat, newBranchIndex);
        
        // If this is a user message and there were assistant messages after it,
        // generate a new response
        if (message.role === 'user' && currentBranch.length > messageIndex + 1) {
          // Wait for the UI to update, then generate new response
          setTimeout(() => generateAssistantForLastUser(), 100);
        }
      };
      
      const cancelEdit = () => {
        editContainer.remove();
        markdownBody.style.display = 'block';
        container.classList.remove('message-editing');
      };
      
      const handleKeydown = (e) => {
        if (e.key === 'Escape') {
          cancelEdit();
        } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          saveEdit();
        }
      };
      
      // Set up event listeners
      textarea.addEventListener('input', autoResize);
      textarea.addEventListener('keydown', handleKeydown);
      saveBtn.addEventListener('click', saveEdit);
      cancelBtn.addEventListener('click', cancelEdit);
      
      // Assemble the edit interface
      actionContainer.appendChild(saveBtn);
      actionContainer.appendChild(cancelBtn);
      editContainer.appendChild(textarea);
      editContainer.appendChild(actionContainer);
      
      // Replace the markdown content with edit interface
      markdownBody.style.display = 'none';
      messageContent.appendChild(editContainer);
      container.classList.add('message-editing');
      
      // Focus and resize
      textarea.focus();
      autoResize();
      
      // Scroll into view if needed
      setTimeout(() => {
        if (actionContainer.getBoundingClientRect().bottom > window.innerHeight) {
          actionContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 10);
    };const logos = {
        'OpenAI': `<svg width="24" height="24" style="transform: scale(1.5);" viewBox="0 0 721 721" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_1637_2935)"><g clip-path="url(#clip1_1637_2935)"><path d="M304.246 295.411V249.828C304.246 245.989 305.687 243.109 309.044 241.191L400.692 188.412C413.167 181.215 428.042 177.858 443.394 177.858C500.971 177.858 537.44 222.482 537.44 269.982C537.44 273.34 537.44 277.179 536.959 281.018L441.954 225.358C436.197 222 430.437 222 424.68 225.358L304.246 295.411ZM518.245 472.945V364.024C518.245 357.304 515.364 352.507 509.608 349.149L389.174 279.096L428.519 256.543C431.877 254.626 434.757 254.626 438.115 256.543L529.762 309.323C556.154 324.679 573.905 357.304 573.905 388.971C573.905 425.436 552.315 459.024 518.245 472.941V472.945ZM275.937 376.982L236.592 353.952C233.235 352.034 231.794 349.154 231.794 345.315V239.756C231.794 188.416 271.139 149.548 324.4 149.548C344.555 149.548 363.264 156.268 379.102 168.262L284.578 222.964C278.822 226.321 275.942 231.119 275.942 237.838V376.986L275.937 376.982ZM360.626 425.922L304.246 394.255V327.083L360.626 295.416L417.002 327.083V394.255L360.626 425.922ZM396.852 571.789C376.698 571.789 357.989 565.07 342.151 553.075L436.674 498.374C442.431 495.017 445.311 490.219 445.311 483.499V344.352L485.138 367.382C488.495 369.299 489.936 372.179 489.936 376.018V481.577C489.936 532.917 450.109 571.785 396.852 571.785V571.789ZM283.134 464.79L191.486 412.01C165.094 396.654 147.343 364.029 147.343 332.362C147.343 295.416 169.415 262.309 203.48 248.393V357.791C203.48 364.51 206.361 369.308 212.117 372.665L332.074 442.237L292.729 464.79C289.372 466.707 286.491 466.707 283.134 464.79ZM277.859 543.48C223.639 543.48 183.813 502.695 183.813 452.314C183.813 448.475 184.294 444.636 184.771 440.797L279.295 495.498C285.051 498.856 290.812 498.856 296.568 495.498L417.002 425.927V471.509C417.002 475.349 415.562 478.229 412.204 480.146L320.557 532.926C308.081 540.122 293.206 543.48 277.854 543.48H277.859ZM396.852 600.576C454.911 600.576 503.37 559.313 514.41 504.612C568.149 490.696 602.696 440.315 602.696 388.976C602.696 355.387 588.303 322.762 562.392 299.25C564.791 289.173 566.231 279.096 566.231 269.024C566.231 200.411 510.571 149.067 446.274 149.067C433.322 149.067 420.846 150.984 408.37 155.305C386.775 134.192 357.026 120.758 324.4 120.758C266.342 120.758 217.883 162.02 206.843 216.721C153.104 230.637 118.557 281.018 118.557 332.357C118.557 365.946 132.95 398.571 158.861 422.083C156.462 432.16 155.022 442.237 155.022 452.309C155.022 520.922 210.682 572.266 274.978 572.266C287.931 572.266 300.407 570.349 312.883 566.028C334.473 587.141 364.222 600.576 396.852 600.576Z" fill="currentColor"/></g></g><defs><clipPath id="clip0_1637_2935"><rect width="720" height="720" fill="white" transform="translate(0.606934 0.899902)"/></clipPath><clipPath id="clip1_1637_2935"><rect width="484.139" height="479.818" fill="white" transform="translate(118.557 120.758)"/></clipPath></defs></svg>`,
        'xAI': `<img src="https://github.com/images/modules/marketplace/models/families/xai.svg" width="16" height="16" alt="xAI" >`,
        'Meta': `<img src="https://github.com/images/modules/marketplace/models/families/meta.svg" width="16" height="16" alt="Meta" >`,
        'Mistral AI': `<img src="https://github.com/images/modules/marketplace/models/families/mistral.svg" width="16" height="16" alt="Mistral AI" >`,
        'Cohere': `<img src="https://github.com/images/modules/marketplace/models/families/cohere.svg" width="16" height="16" alt="Cohere" >`,
        'Core42': `<img src="https://github.com/images/modules/marketplace/models/families/core42.svg" width="16" height="16" alt="Core42" >`,
        'JAIS': `<img src="https://github.com/images/modules/marketplace/models/families/core42.svg" width="16" height="16" alt="JAIS" >`,
        'Microsoft': `<img src="https://github.com/images/modules/marketplace/models/families/microsoft.svg" width="16" height="16" alt="Microsoft" >`,
        'DeepSeek': `<img src="https://github.com/images/modules/marketplace/models/families/deepseek.svg" width="16" height="16" alt="Microsoft" >`,
        'Azure': `<img src="https://github.com/images/modules/marketplace/models/families/azure-openai.svg" width="16" height="16" alt="Azure" >`,
        'AI21 Labs': `<img src="https://www.ai21.com/wp-content/uploads/2024/11/ai21-logo.svg" width="16" height="16" alt="AI21">`,
        'Google': `<img src="https://www.gstatic.com/lamda/images/gemini_sparkle_aurora_33f86dc0c0257da337c63.svg" width="16" height="16" alt="Google" >`,
        'Gemini': `<img src="https://www.gstatic.com/lamda/images/gemini_sparkle_aurora_33f86dc0c0257da337c63.svg" width="16" height="16" alt="Google" >`,
        'Anthropic': `<img src="https://cdn.brandfetch.io/idmJWF3N06/theme/light/symbol.svg?c=1bxid64Mup7aczewSAYMX&t=1721803183866" width="16" height="16" alt="Anthropic" >`
      };

      return logos[publisher] || `<span style="font-size:10px; font-weight:bold; color: #6366f1;">${publisher?.charAt(0) || '?'}</span>`;
    }
    function selectModel(id){
      const m = models.find(x=>x.id===id);
      if(!m) return;

      // Store selected model in localStorage
      localStorage.setItem('selected_model', id);

      // Update desktop dropdown
      const selectedModelName = document.getElementById('selectedModelName');
      const selectedModelIcon = document.getElementById('selectedModelIcon');
      if(selectedModelName) {
        selectedModelName.textContent = m.name;
        selectedModelName.dataset.modelId = m.id; // Store the model ID
      }
      if(selectedModelIcon) selectedModelIcon.innerHTML = getModelLogo(m.publisher);

      // Update mobile dropdown
      const mobileSelectedModelName = document.getElementById('mobileSelectedModelName');
      const mobileSelectedModelIcon = document.getElementById('mobileSelectedModelIcon');
      if(mobileSelectedModelName) {
        mobileSelectedModelName.textContent = m.name.length > 8 ? m.name.substring(0, 8) + '...' : m.name;
        mobileSelectedModelName.dataset.modelId = m.id; // Store the model ID
      }
      if(mobileSelectedModelIcon) mobileSelectedModelIcon.innerHTML = getModelLogo(m.publisher);

      updateRateLimitInfo(m);
    }

    function updateRateLimitInfo(model){
      if(model?.limits || model?.rate_limit){
        const tier = (model.rate_limit_tier || model.tier || '?').toLowerCase();
        const rpd = model.rate_limit?.requests_per_day || model.limits?.requests_per_day || '';
        const inTok = model.limits?.max_input_tokens ?? model.limits?.input ?? '';
        const outTok = model.limits?.max_output_tokens ?? model.limits?.output ?? '';

        // Format large numbers with abbreviations
        const formatNumber = (num) => {
          if (num === '' || num === 'N/A') return num;
          const n = parseInt(num);
          if (n >= 1000000) return `${Math.floor(n/1000000)}M`;
          if (n >= 1000) return `${Math.floor(n/1000)}K`;
          return n.toString();
        };

        rateLimitInfo.innerHTML = `&lt;div class="text-xs text-gray-400"&gt;${tier}: ${rpd} req/day, ${formatNumber(inTok)} in, ${formatNumber(outTok)} out&lt;/div&gt;`;
      } else {
        rateLimitInfo.innerHTML='';
      }
    }

    // Chat management
    function loadChatHistory(){
      chatHistory.innerHTML='';
      chats.forEach(chat=>{
        const el=document.createElement('div');
        el.className='p-2 hover:bg-gray-800 rounded cursor-pointer text-sm truncate flex justify-between items-center chat-history-item relative';
        el.dataset.chatId = chat.id;

        const title=document.createElement('span');
        title.className='flex-1 truncate';
        title.textContent=chat.title||'Untitled Chat';

        const del=document.createElement('button');
        del.className='text-red-400 ml-2 font-bold del-btn';
        del.innerHTML='&lt;svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="3,6 5,6 21,6"&gt;&lt;/polyline&gt;&lt;path d="m19,6v14c0,1-1,2-2,2H7c-1,0-2-1-2-2V6m3,0V4c0-1,1-2,2-2h4c1,0,2,1,2,2v2"&gt;&lt;/path&gt;&lt;/svg&gt;';
        del.addEventListener('click',e=>{ e.stopPropagation(); deleteChat(chat.id); });

        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;circle cx="9" cy="12" r="1"&gt;&lt;/circle&gt;&lt;circle cx="9" cy="5" r="1"&gt;&lt;/circle&gt;&lt;circle cx="9" cy="19" r="1"&gt;&lt;/circle&gt;&lt;circle cx="15" cy="12" r="1"&gt;&lt;/circle&gt;&lt;circle cx="15" cy="5" r="1"&gt;&lt;/circle&gt;&lt;circle cx="15" cy="19" r="1"&gt;&lt;/circle&gt;&lt;/svg&gt;';

        el.appendChild(dragHandle);
        el.appendChild(title);
        el.appendChild(del);
        el.addEventListener('click',()=>loadChat(chat.id));
        chatHistory.appendChild(el);
      });
    }

    // TODO: Replace GPT-4.1 mini with Cerebras models (especially less used ones like llama 70B)
    // when external API keys get added due to per-model rate limits
    function generateChatTitle(firstUserMessage) {
      const token = localStorage.getItem('gh_token');
      if (!token || !token.trim() || token.trim()=="" || token == "" || !firstUserMessage) return Promise.resolve(null);

      // Use selected title generation model or default to GPT-4.1 Mini
      const titleGenerationModel = localStorage.getItem('selected_title_model') || 'openai/gpt-4.1-mini';

      const titleSystemPrompt = `You are a chat title generator. Generate a concise, descriptive title (2-10 words) for a conversation based on the user's first message.

Rules:
- Keep it under 10 words
- Make it descriptive but not too specific
- Don't use quotes or special characters
- Focus on the main topic or intent
    // Message actions (global functions)
    window.copyMessage = (btn)=>{
      const container = btn.closest('.user-bubble, .assistant-response');
      if(!container) return;
      const txt = container.querySelector('.markdown-body').innerText.trim();
      navigator.clipboard.writeText(txt).then(() => {
        btn.style.color = '#10b981';
        old_btn = btn.innerHTML;
        // Change button to checkmark icon
        btn.innerHTML = '&lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"&gt;&lt;/path&gt;&lt;polyline points="16 2 16 4 8 4 8 2"&gt;&lt;/polyline&gt;&lt;polyline points="8 10 16 10"&gt;&lt;/polyline&gt;&lt;polyline points="8 14 16 14"&gt;&lt;/polyline&gt;&lt;polyline points="8 18 16 18"&gt;&lt;/polyline&gt;&lt;/svg&gt;';
        // Reset button after 1 second
        setTimeout(() => {btn.style.color = ''; btn.innerHTML = old_btn}, 1000);
      });
    };

    // Branching system functions
    function initializeBranches(chat) {
      if (!chat.branches) {
        chat.branches = [chat.messages || []];
        chat.currentBranch = 0;
        delete chat.messages;
      }
    }

    function getCurrentBranch(chat) {
      if (!chat.branches) initializeBranches(chat);
      return chat.branches[chat.currentBranch || 0] || [];
    }

    function createNewBranch(chat, fromIndex, newMessage) {
      if (!chat.branches) initializeBranches(chat);
      
      const currentBranch = getCurrentBranch(chat);
      const newBranch = currentBranch.slice(0, fromIndex);
      if (newMessage) {
        newBranch.push(newMessage);
      }
      
      chat.branches.push(newBranch);
      chat.currentBranch = chat.branches.length - 1;
      
      localStorage.setItem('chat_history', JSON.stringify(chats));
      return chat.currentBranch;
    }

    function switchToBranch(chat, branchIndex) {
      if (!chat.branches || branchIndex < 0 || branchIndex >= chat.branches.length) return;
      chat.currentBranch = branchIndex;
      localStorage.setItem('chat_history', JSON.stringify(chats));
      loadChat(chat.id);
    }

    function renderBranchButtons(chat, messageIndex) {
      if (!chat.branches || chat.branches.length <= 1) return '';
      
      const relevantBranches = chat.branches.filter((branch, index) => {
        if (branch.length <= messageIndex) return false;
        
        const currentBranch = getCurrentBranch(chat);
        return branch.slice(0, messageIndex).every((msg, i) => {
          return currentBranch[i] && 
                 msg.content === currentBranch[i].content && 
                 msg.role === currentBranch[i].role;
        });
      });
      
      if (relevantBranches.length <= 1) return '';
      
      return relevantBranches.map(branch => {
        const branchIndex = chat.branches.indexOf(branch);
        const branchNumber = branchIndex + 1;
        const isActive = branchIndex === chat.currentBranch;
        return `<button class="branch-btn ${isActive ? 'active' : ''}" onclick="switchToBranch(chats.find(c => c.id === '${chat.id}'), ${branchIndex})">${branchNumber}</button>`;
      }).join('');
    }

    function updateBranchNavigation() {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.branches) return;
      
      const messageElements = chatBox.querySelectorAll('.user-bubble, .assistant-response');
      messageElements.forEach((element, index) => {
        const branchNav = element.querySelector('.branch-navigation');
        const branchButtons = element.querySelector('.branch-buttons');
        
        if (branchNav && branchButtons) {
          const buttonsHtml = renderBranchButtons(chat, index);
          branchButtons.innerHTML = buttonsHtml;
          branchNav.style.display = buttonsHtml ? 'flex' : 'none';
        }
      });
    }

    // Make functions globally available
    window.switchToBranch = switchToBranch;
    window.createNewBranch = createNewBranch;
    window.updateBranchNavigation = updateBranchNavigation;
    function createNewBranch(chat, fromIndex, newMessage) {
      if (!chat.branches) initializeBranches(chat);
      
      const currentBranch = getCurrentBranch(chat);
      const newBranch = currentBranch.slice(0, fromIndex);
      if (newMessage) {
        newBranch.push(newMessage);
      }
      
      chat.branches.push(newBranch);
      chat.currentBranch = chat.branches.length - 1;
      return chat.currentBranch;
    }
    
    // Continue with next functions...
        const branchIndex = createNewBranch(chat, messageIndex, newMessage);
        
        // Update display
        messageContent.innerHTML = marked.parse(newText);
        editor.remove();
        controls.remove();
        
        // Regenerate assistant response if user message was edited
        if (container.dataset.role === 'user') {
          // Remove all messages after this one in current view
          const allMessages = chatBox.querySelectorAll('.user-bubble, .assistant-response');
          for (let i = messageIndex + 1; i < allMessages.length; i++) {
            allMessages[i].remove();
          }
          
          // Update the chat data to only include messages up to the edit
          const newBranch = chat.branches[chat.currentBranch];
          newBranch.splice(messageIndex + 1);
          localStorage.setItem('chat_history', JSON.stringify(chats));
          
          // Generate new assistant response
          setTimeout(() => generateAssistantForLastUser(), 100);
        }
        
        // Update branch navigation
        updateBranchNavigation();
      };
      
      // Cancel function
      const cancelEdit = () => {
        editor.remove();
        controls.remove();
      };
      
      // Event handlers
      controls.querySelector('.save').addEventListener('click', saveEdit);
      controls.querySelector('.cancel').addEventListener('click', cancelEdit);
      
      editor.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        } else if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          saveEdit();
        }
      });
      
      // Replace content with editor
      messageContent.style.display = 'none';
      messageContent.parentNode.insertBefore(editor, messageContent);
      messageContent.parentNode.insertBefore(controls, messageContent.nextSibling);
      
      // Focus and resize
      editor.focus();
      autoResize();
    };

      return fetch('https://models.github.ai/inference/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: titleGenerationModel,
          messages: [
            { role: 'system', content: titleSystemPrompt },
            { role: 'user', content: firstUserMessage }
          ],
          temperature: 0.7
        })
      })
      .then(response => {
        if (!response.ok) throw new Error('Title generation failed');
        return response.json();
      })
      .then(data => {
        const title = data.choices?.[0]?.message?.content?.trim();
        return title || null;
      })
      .catch(error => {
        console.warn('Failed to generate chat title:', error);
        return null;
      });
    }
    // Edit functionality for chat history
    document.getElementById('editChatsBtn')?.addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('editChatsBtn');
      sidebar.classList.toggle('editing');
      btn.classList.toggle('active');

      // Toggle icon between edit and check
      const svg = btn.querySelector('svg');
      if (sidebar.classList.contains('editing')) {
        svg.innerHTML = '&lt;path d="M20 6L9 17l-5-5"&gt;&lt;/path&gt;';
      } else {
        svg.innerHTML = '&lt;path d="M12 20h9"&gt;&lt;/path&gt;&lt;path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"&gt;&lt;/path&gt;';
      }
      // Toggle delete buttons
      document.querySelectorAll('.del-btn').forEach(elem => {
        elem.style.opacity = sidebar.classList.contains('editing') ? '1' : '0';
      });
    });
    
    function loadChat(id){
      const chat = chats.find(c=>c.id===id);
      if(!chat) return;
      currentChatId = id;

      // Initialize branches if needed (for legacy chat format compatibility)
      if (!chat.branches && chat.messages) {
        chat.branches = [chat.messages];
        chat.currentBranch = 0;
        delete chat.messages;
      }

      const currentBranch = chat.branches ? chat.branches[chat.currentBranch || 0] : [];
      
      // Clear existing messages
      const existingMessages = chatBox.querySelectorAll('.user-bubble, .assistant-response');
      existingMessages.forEach(el => el.remove());

      // Show welcome message if chat is empty, otherwise hide it
      if (currentBranch.length === 0) {
        const chatBoxContainer = chatBox.querySelector('.max-w-3xl');
        if (chatBoxContainer) {
          chatBoxContainer.innerHTML = '&lt;div id="welcomeMessage" class="text-center py-10 text-gray-500"&gt;&lt;h2 class="text-2xl mb-4"&gt;How can I help you today?&lt;/h2&gt;&lt;p class="text-sm"&gt;Start a conversation by typing a message below&lt;/p&gt;&lt;/div&gt;';
        }
      } else {
        // Remove welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) welcomeMessage.remove();

        // Load messages without triggering storage save
        currentBranch.forEach((m, index) => {
          if(m.role === 'user') {
            const bubble = document.createElement('div');
            bubble.className = 'user-bubble';
            bubble.innerHTML = `
              &lt;div class="message-content"&gt;
                &lt;div class="markdown-body"&gt;${marked.parse(m.content)}&lt;/div&gt;
              &lt;/div&gt;
              &lt;div class="message-bottom-actions"&gt;
                &lt;div class="action-buttons"&gt;
                  &lt;button class="bottom-action-btn" onclick="editMessage(this)" title="Edit"&gt;
                    &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;path d="M12 20h9"&gt;&lt;/path&gt;
                      &lt;path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                    Edit
                  &lt;/button&gt;
                  &lt;button class="bottom-action-btn" onclick="copyMessage(this)" title="Copy"&gt;
                    &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;
                      &lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                    Copy
                  &lt;/button&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            `;
            bubble.dataset.role = 'user';
            
            // Add branch navigation if applicable
            const branchNav = renderBranchNavigation(index);
            if (branchNav) {
              const bottomActions = bubble.querySelector('.message-bottom-actions');
              bottomActions.appendChild(branchNav);
            }
            
            chatBox.appendChild(bubble);
          } else if(m.role === 'assistant') {
            const response = document.createElement('div');
            response.className = 'assistant-response';
            response.innerHTML = `
              &lt;div class="message-content"&gt;
                &lt;div class="markdown-body"&gt;${marked.parse(m.content)}&lt;/div&gt;
              &lt;/div&gt;
              &lt;div class="message-bottom-actions"&gt;
                &lt;div class="action-buttons"&gt;
                  &lt;button class="bottom-action-btn" onclick="regenerateMessage(this)" title="Regenerate"&gt;
                    &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;polyline points="23,4 23,10 17,10"&gt;&lt;/polyline&gt;
                      &lt;polyline points="1,20 1,14 7,14"&gt;&lt;/polyline&gt;
                      &lt;path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4-4.64,4.36A9,9,0,0,1,3.51,15"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                    Regenerate
                  &lt;/button&gt;
                  &lt;button class="bottom-action-btn" onclick="copyMessage(this)" title="Copy"&gt;
                    &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;
                      &lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                    Copy
                  &lt;/button&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            `;
            response.dataset.role = 'assistant';
            
            // Add branch navigation if applicable
            const branchNav = renderBranchNavigation(index);
            if (branchNav) {
              const bottomActions = response.querySelector('.message-bottom-actions');
              bottomActions.appendChild(branchNav);
            }
            
            chatBox.appendChild(response);
          }
        });
      }

      chatBox.scrollTop = chatBox.scrollHeight;

      // Highlight the currently selected chat
      const chatItems = document.querySelectorAll('.chat-history-item');
      chatItems.forEach(item => item.classList.remove('focused'));
      const currentItem = document.querySelector(`[data-chat-id="${id}"]`);
      if (currentItem) currentItem.classList.add('focused');
    }
    
    function createNewChat(){
      currentChatId='chat_'+Date.now();
      const newChat={
        id:currentChatId,
        title:'New Chat',
        branches:[[]],
        currentBranch:0,
        createdAt:new Date().toISOString()
      };
      chats.push(newChat);
      localStorage.setItem('chat_history', JSON.stringify(chats));
      chatBox.innerHTML=`&lt;div class="max-w-3xl mx-auto"&gt;&lt;div id="welcomeMessage" class="text-center py-10 text-gray-500"&gt;&lt;h2 class="text-2xl mb-4"&gt;How can I help you today?&lt;/h2&gt;&lt;p class="text-sm"&gt;Start a conversation by typing a message below&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;`;
      loadChatHistory();
    }
    
    function goToHomepage() {
      // Check if there's already an empty "New Chat" available
      const emptyNewChat = chats.find(c => {
        if (c.title !== 'New Chat') return false;
        
        // Check if it's branches-based
        if (c.branches) {
          const currentBranch = c.branches[c.currentBranch || 0];
          return currentBranch.length === 0;
        }
        
        // Legacy messages format
        return (c.messages || []).length === 0;
      });

      if (emptyNewChat) {
        // Load the existing empty chat
        loadChat(emptyNewChat.id);
      } else {
        // Create a new chat only if no empty one exists
        createNewChat();
      }
    }
    
    function appendUserMessage(content){
      const welcome=document.getElementById('welcomeMessage');
      if(welcome) welcome.remove();

      const bubble = document.createElement('div');
      bubble.className = 'user-bubble';
      bubble.innerHTML = `
        &lt;div class="message-content"&gt;
          &lt;div class="markdown-body"&gt;${marked.parse(content)}&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="message-bottom-actions"&gt;
          &lt;div class="action-buttons"&gt;
            &lt;button class="bottom-action-btn" onclick="editMessage(this)" title="Edit"&gt;
              &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                &lt;path d="M12 20h9"&gt;&lt;/path&gt;
                &lt;path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"&gt;&lt;/path&gt;
              &lt;/svg&gt;
              Edit
            &lt;/button&gt;
            &lt;button class="bottom-action-btn" onclick="copyMessage(this)" title="Copy"&gt;
              &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                &lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;
                &lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;
              &lt;/svg&gt;
              Copy
            &lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      `;
      bubble.dataset.role = 'user';
      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;

      const chat = chats.find(c => c.id === currentChatId);
      if(chat) {
        // Initialize branches if needed
        if (!chat.branches) {
          chat.branches = [chat.messages || []];
          chat.currentBranch = 0;
          delete chat.messages;
        }

        const currentBranch = chat.branches[chat.currentBranch];
        if(!currentBranch.some(m => m.content === content && m.role === 'user')){
          currentBranch.push({role: 'user', content});
          localStorage.setItem('chat_history', JSON.stringify(chats));

          // Generate title for new chats after first user message
          if (chat.title === 'New Chat' && currentBranch.filter(m => m.role === 'user').length === 1) {
            updateChatTitle(currentChatId, content);
          }
        }
      }
    }

    // System prompt
    const systemPromptToggle=document.getElementById('systemPromptToggle');
    const systemPromptEditor=document.getElementById('systemPromptEditor');
    systemPromptToggle?.addEventListener('click',()=> systemPromptEditor?.classList.toggle('show'));

    // Message actions (global functions)
    window.copyMessage = (btn)=>{
      const container = btn.closest('.user-bubble, .assistant-response');
      if(!container) return;
      const txt = container.querySelector('.markdown-body').innerText.trim();
      navigator.clipboard.writeText(txt);
    };

    window.deleteMessage = (btn) => {
      const container = btn.closest('.user-bubble, .assistant-response');
      if (!container) return;
      
      if (confirm('Are you sure you want to delete this message?')) {
        const messageIndex = Array.from(chatBox.querySelectorAll('.user-bubble, .assistant-response')).indexOf(container);
        
        const chat = chats.find(c => c.id === currentChatId);
        if (chat) {
          // Initialize branches if needed
          if (!chat.branches) {
            chat.branches = [chat.messages || []];
            chat.currentBranch = 0;
            delete chat.messages;
          }
          
          const currentBranch = chat.branches[chat.currentBranch];
          
          // Remove the message and all messages after it
          currentBranch.splice(messageIndex, currentBranch.length - messageIndex);
          localStorage.setItem('chat_history', JSON.stringify(chats));
          
          // Reload the chat to reflect changes
          loadChat(currentChatId);
        }
      }
    };

    window.editMessage = (btn) => {
      const container = btn.closest('.user-bubble');
      if (!container || container.dataset.role !== 'user') return;
      
      // Don't allow editing if already in edit mode
      if (container.querySelector('.inline-edit-textarea')) return;
      
      const messageContent = container.querySelector('.message-content');
      const markdownBody = messageContent.querySelector('.markdown-body');
      const originalText = markdownBody.innerText.trim();
      
      // Create inline editing elements
      const editor = document.createElement('textarea');
      editor.className = 'inline-edit-textarea';
      editor.value = originalText;
      
      const controls = document.createElement('div');
      controls.className = 'inline-edit-actions';
      controls.innerHTML = `
        &lt;button class="inline-edit-btn save"&gt;
          &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
            &lt;polyline points="20,6 9,17 4,12"&gt;&lt;/polyline&gt;
          &lt;/svg&gt;
          Save
        &lt;/button&gt;
        &lt;button class="inline-edit-btn cancel"&gt;
          &lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
            &lt;line x1="18" y1="6" x2="6" y2="18"&gt;&lt;/line&gt;
            &lt;line x1="6" y1="6" x2="18" y2="18"&gt;&lt;/line&gt;
          &lt;/svg&gt;
          Cancel
        &lt;/button&gt;
      `;
      
      // Auto-resize function
      const autoResize = () => {
        editor.style.height = 'auto';
        editor.style.height = editor.scrollHeight + 'px';
      };
      
      editor.addEventListener('input', autoResize);
      
      // Save function
      const saveEdit = () => {
        const newText = editor.value.trim();
        if (newText && newText !== originalText) {
          // Create new branch for the edit
          const chat = chats.find(c => c.id === currentChatId);
          if (chat) {
            // Initialize branches if needed
            if (!chat.branches) {
              chat.branches = [chat.messages || []];
              chat.currentBranch = 0;
              delete chat.messages;
            }
            
            // Find the message index in current branch
            const allMessages = chatBox.querySelectorAll('.user-bubble, .assistant-response');
            const messageIndex = Array.from(allMessages).indexOf(container);
            
            // Create new branch from current branch up to the edited message
            const currentBranch = chat.branches[chat.currentBranch];
            const newBranch = [...currentBranch.slice(0, messageIndex + 1)];
            newBranch[messageIndex] = { role: 'user', content: newText };
            
            // Add new branch and switch to it
            chat.branches.push(newBranch);
            chat.currentBranch = chat.branches.length - 1;
            
            // Save and reload
            localStorage.setItem('chat_history', JSON.stringify(chats));
            loadChat(currentChatId);
            
            // After reload, regenerate assistant response
            setTimeout(() => generateAssistantForLastUser(), 100);
          }
        } else {
          cancelEdit();
        }
      };
      
      // Cancel function
      const cancelEdit = () => {
        editor.remove();
        controls.remove();
        markdownBody.style.display = '';
      };
      
      // Event handlers
      controls.querySelector('.save').addEventListener('click', saveEdit);
      controls.querySelector('.cancel').addEventListener('click', cancelEdit);
      
      editor.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        } else if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          saveEdit();
        }
      });
      
      // Replace content with editor
      markdownBody.style.display = 'none';
      messageContent.appendChild(editor);
      messageContent.appendChild(controls);
      
      // Focus and resize
      editor.focus();
      autoResize();
      const textarea = document.createElement('textarea');
      textarea.className = 'edit-textarea';
      textarea.value = originalText;
      textarea.style.cssText = `
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        resize: none;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
        min-height: 20px;
      `;
      
      // Create action buttons container
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'edit-actions';
      buttonsContainer.style.cssText = `
        display: flex;
        gap: 8px;
        margin-top: 8px;
        justify-content: flex-end;
      `;
      
      // Create save button
      const saveBtn = document.createElement('button');
      saveBtn.className = 'edit-btn save-btn';
      saveBtn.innerHTML = `
        &lt;svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
          &lt;polyline points="20,6 9,17 4,12"&gt;&lt;/polyline&gt;
        &lt;/svg&gt;
      `;
      saveBtn.style.cssText = `
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.5);
        color: #22c55e;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      `;
      
      // Create cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'edit-btn cancel-btn';
      cancelBtn.innerHTML = `
        &lt;svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
          &lt;line x1="18" y1="6" x2="6" y2="18"&gt;&lt;/line&gt;
          &lt;line x1="6" y1="6" x2="18" y2="18"&gt;&lt;/line&gt;
        &lt;/svg&gt;
      `;
      cancelBtn.style.cssText = `
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #ef4444;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      `;
      
      // Auto-resize function
      const autoResize = () => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      };
      
      // Save function
      const saveEdit = () => {
        const newText = textarea.value.trim();
        if (newText && newText !== originalText) {
          // Create new branch for the edit
          const chat = chats.find(c => c.id === currentChatId);
          if (chat) {
            // Initialize branches if needed
            if (!chat.branches) {
              chat.branches = [chat.messages || []];
              chat.currentBranch = 0;
              delete chat.messages;
            }
            
            // Find the message index in current branch
            const currentBranch = chat.branches[chat.currentBranch];
            const messageIndex = Array.from(chatBox.querySelectorAll('.user-bubble, .assistant-response'))
              .indexOf(container);
            
            // Create new branch from current branch up to the edited message
            const newBranch = [...currentBranch.slice(0, messageIndex + 1)];
            newBranch[messageIndex] = { role: 'user', content: newText };
            
            // Add new branch and switch to it
            chat.branches.push(newBranch);
            chat.currentBranch = chat.branches.length - 1;
            
            // Save and reload
            localStorage.setItem('chat_history', JSON.stringify(chats));
            loadChat(currentChatId);
            
            // After reload, regenerate assistant response
            setTimeout(() => generateAssistantForLastUser(), 100);
          }
        } else {
          cancelEdit();
        }
      };
      
      // Cancel function
      const cancelEdit = () => {
        editContainer.remove();
        markdownBody.style.display = '';
        actionContainer.style.display = '';
      };
      
      // Event listeners
      textarea.addEventListener('input', autoResize);
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        } else if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          saveEdit();
        }
      });
      
      saveBtn.addEventListener('click', saveEdit);
      cancelBtn.addEventListener('click', cancelEdit);
      
      // Assemble and insert
      editContainer.appendChild(textarea);
      buttonsContainer.appendChild(saveBtn);
      buttonsContainer.appendChild(cancelBtn);
      editContainer.appendChild(buttonsContainer);
      
      container.appendChild(editContainer);
      
      // Focus and auto-resize
      textarea.focus();
      autoResize();
    };

    window.regenerateMessage = (btn)=>{
      const container = btn.closest('.assistant-response');
      if(!container) return;
      container.remove();
      rebuildMessagesFromDOM();
      generateAssistantForLastUser();
    };

    function rebuildMessagesFromDOM(){
      const containers = chatBox.querySelectorAll('.user-bubble, .assistant-response');
      const rebuilt = [];
      containers.forEach(container => {
        const role = container.dataset.role;
        if(!role) return;
        const text = container.querySelector('.markdown-body').innerText.trim();
        rebuilt.push({role, content: text});
      });
      const chat = chats.find(c => c.id === currentChatId);
      if(chat){
        // Initialize branches if needed
        if (!chat.branches) {
          chat.branches = [chat.messages || []];
          chat.currentBranch = 0;
          delete chat.messages;
        }
        
        const sys = document.getElementById('systemPromptText')?.value.trim();
        const filteredRebuilt = rebuilt.filter(m => m.role !== 'system');
        chat.branches[chat.currentBranch] = sys ? [{role:'system', content:sys}, ...filteredRebuilt] : filteredRebuilt;
        localStorage.setItem('chat_history', JSON.stringify(chats));
      }
    }

    function findMessageIndex(container) {
      const chat = chats.find(c => c.id === currentChatId);
      
      // Initialize branches if needed
      if (!chat.branches) {
        chat.branches = [chat.messages || []];
        chat.currentBranch = 0;
        delete chat.messages;
      }

      const currentBranch = chat.branches[chat.currentBranch];
      let messages = [...currentBranch];
      const sys = document.getElementById('systemPromptText')?.value.trim();
      if(sys && (!messages[0] || messages[0].role !== 'system')) {
        messages.unshift({role: 'system', content: sys});
      }
      
      // Find message index logic here
      return -1; // placeholder
    }
    
    function switchToBranch(chat, branchIndex) {
      if (!chat || !chat.branches || branchIndex >= chat.branches.length) return;

      chat.currentBranch = branchIndex;
      localStorage.setItem('chat_history', JSON.stringify(chats));
      loadChat(currentChatId);
    }

    function renderBranchNavigation(messageIndex) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat?.branches || chat.branches.length <= 1) return null;

      // Check if this message has branches
      const branchesWithThisMessage = chat.branches.filter(branch => 
        branch.length > messageIndex && branch[messageIndex]
      );

      if (branchesWithThisMessage.length <= 1) return null;

      const branchContainer = document.createElement('div');
      branchContainer.className = 'branch-navigation';

      const prevBtn = document.createElement('button');
      prevBtn.className = 'branch-btn';
      prevBtn.innerHTML = '&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="15,18 9,12 15,6"&gt;&lt;/polyline&gt;&lt;/svg&gt;';
      prevBtn.disabled = chat.currentBranch === 0;

      const branchIndicator = document.createElement('span');
      branchIndicator.className = 'branch-indicator';
      branchIndicator.textContent = `${chat.currentBranch + 1} of ${chat.branches.length}`;

      const nextBtn = document.createElement('button');
      nextBtn.className = 'branch-btn';
      nextBtn.innerHTML = '&lt;svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;&lt;polyline points="9,18 15,12 9,6"&gt;&lt;/polyline&gt;&lt;/svg&gt;';
      nextBtn.disabled = chat.currentBranch === chat.branches.length - 1;

      prevBtn.addEventListener('click', () => switchToBranch(chat, chat.currentBranch - 1));
      nextBtn.addEventListener('click', () => switchToBranch(chat, chat.currentBranch + 1));

      branchContainer.appendChild(prevBtn);
      branchContainer.appendChild(branchIndicator);
      branchContainer.appendChild(nextBtn);

      return branchContainer;
    }

    window.regenerateMessage = (btn)=>{
      const container = btn.closest('.assistant-response');
      if(!container) return;
      container.remove();
      rebuildMessagesFromDOM();
      generateAssistantForLastUser();
    };

    function rebuildMessagesFromDOM(){
      const containers = chatBox.querySelectorAll('.user-bubble, .assistant-response');
      const rebuilt = [];
      containers.forEach(container => {
        const role = container.dataset.role;
        if(!role) return;
        const text = container.querySelector('.markdown-body').innerText.trim();
        rebuilt.push({role, content: text});
      });
      const chat = chats.find(c => c.id === currentChatId);
      if(chat){
        // Initialize branches if needed
        if (!chat.branches) {
          chat.branches = [chat.messages || []];
          chat.currentBranch = 0;
          delete chat.messages;
        }
        
        const sys = document.getElementById('systemPromptText')?.value.trim();
        const filteredRebuilt = rebuilt.filter(m => m.role !== 'system');
        chat.branches[chat.currentBranch] = sys ? [{role:'system', content:sys}, ...filteredRebuilt] : filteredRebuilt;
        localStorage.setItem('chat_history', JSON.stringify(chats));
      }
    }
      if (!chat.branches) {
        chat.branches = [chat.messages || []];
        chat.currentBranch = 0;
        delete chat.messages;
      }

      const currentBranch = chat.branches[chat.currentBranch];
      let messages = [...currentBranch];
      const sys = document.getElementById('systemPromptText')?.value.trim();
      if(sys && (!messages[0] || messages[0].role !== 'system')) {
        messages.unshift({role: 'system', content: sys});
      }
      
      const chat = chats.find(c => c.id === currentChatId);
      if(chat){
        const sys = document.getElementById('systemPromptText')?.value.trim();
        chat.messages = sys ? [{role:'system', content:sys}, ...rebuilt.filter(m => m.role !== 'system')] : rebuilt;
        localStorage.setItem('chat_history', JSON.stringify(chats));
      }
    }
    stopBtn.classList.add('hidden'); // Hide stop button by default
    function sendMessage(){
      const msg = messageInput.value.trim();
      if(!msg) return;
      if(!currentChatId) createNewChat();

      appendUserMessage(msg);

      // Show stop button, hide send button
      sendBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');

      // Create streaming container
      const streamingResponse = document.createElement('div');
      streamingResponse.className = 'assistant-response streaming';
      streamingResponse.innerHTML = '&lt;div class="text-sm text-indigo-300"&gt;Thinking...&lt;/div&gt;';
      chatBox.appendChild(streamingResponse);
      chatBox.scrollTop = chatBox.scrollHeight;

      const token = localStorage.getItem('gh_token');
      const selectedModelElement = document.getElementById('selectedModelName');
      const modelId = selectedModelElement?.dataset.modelId;
      const model = models.find(m => m.id === modelId);

      // TODO: When external API keys are added, implement intelligent model routing
      // to prefer Cerebras models (especially for less used ones like llama 70B) for better rate limits

      if(!token || !token.trim() || token.trim()=="" || token == "") {
        streamingResponse.classList.remove('streaming');
        streamingResponse.innerHTML = '&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; No authentication token found. Please sign in with GitHub.&lt;/div&gt;';
        resetSendButton();
        return;
      }

      if(!model || !model.id) {
        streamingResponse.classList.remove('streaming');
        streamingResponse.innerHTML = '&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; No valid model selected. Please select a model from the dropdown.&lt;/div&gt;';
        resetSendButton();
        return;
      }

      const chat = chats.find(c => c.id === currentChatId);
      if(!chat) {
        streamingResponse.classList.remove('streaming');
        streamingResponse.innerHTML = '&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; No chat found.&lt;/div&gt;';
        resetSendButton();
        return;
      }

      // Initialize branches if needed
      if (!chat.branches) {
        chat.branches = [chat.messages || []];
        chat.currentBranch = 0;
        delete chat.messages;
      }

      let messages = [...chat.branches[chat.currentBranch]];
      const sys = document.getElementById('systemPromptText')?.value.trim();
      if(sys && (!messages[0] || messages[0].role !== 'system')) {
        messages.unshift({role: 'system', content: sys});
      }

      // Create abort controller for stopping
      currentAbortController = new AbortController();

      fetch('https://models.github.ai/inference/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          messages,
          model: model.id,
          stream: true,
//TODO The token limit should be adjustable, but it does not matter for Github Models as they have no TPM/TPD limits
        }),
        signal: currentAbortController.signal
      })
      .then(response => {
        if(!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullContent = '';

        function readStream() {
          reader.read().then(({done, value}) => {
            if(done) {
              // Finalize the message
              streamingResponse.classList.remove('streaming');
              streamingResponse.innerHTML = `
                &lt;div class="markdown-body"&gt;${marked.parse(fullContent || '*No response received*')}&lt;/div&gt;
                &lt;div class="message-actions"&gt;
                  &lt;button class="action-btn" onclick="regenerateMessage(this)" title="Regenerate"&gt;
                    &lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;polyline points="23,4 23,10 17,10"&gt;&lt;/polyline&gt;
                      &lt;polyline points="1,20 1,14 7,14"&gt;&lt;/polyline&gt;
                      &lt;path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4-4.64,4.36A9,9,0,0,1,3.51,15"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                  &lt;/button&gt;
                  &lt;button class="action-btn" onclick="copyMessage(this)" title="Copy"&gt;
                    &lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;
                      &lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                  &lt;/button&gt;
                  &lt;button class="action-btn" onclick="deleteMessage(this)" title="Delete"&gt;
                    &lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;polyline points="3,6 5,6 21,6"&gt;&lt;/polyline&gt;
                      &lt;path d="m19,6v14c0,1-1,2-2,2H7c-1,0-2-1-2-2V6m3,0V4c0-1,1-2,2-2h4c1,0,2,1,2,2v2"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                  &lt;/button&gt;
                &lt;/div&gt;
              `;
              streamingResponse.dataset.role = 'assistant';

              // Save to chat history
              if(fullContent) {
                const currentBranch = chat.branches[chat.currentBranch];
                if(!currentBranch.some(m => m.content === fullContent && m.role === 'assistant')) {
                  currentBranch.push({role: 'assistant', content: fullContent});
                  localStorage.setItem('chat_history', JSON.stringify(chats));
                }
              }
              resetSendButton();
              return;
            }

            const chunk = decoder.decode(value, {stream: true});
            const lines = chunk.split('\n').filter(line => line.trim() !== '');

            for(const line of lines) {
              if(line.startsWith('data: ')) {
                const data = line.slice(6);
                if(data === '[DONE]') {
                  // Stream completed - handled above
                  return;
                }

                try {
                  const parsed = JSON.parse(data);
                  const content = parsed.choices?.[0]?.delta?.content || '';
                  if(content) {
                    fullContent += content;
                    streamingResponse.innerHTML = `&lt;div class="markdown-body"&gt;${marked.parse(fullContent)}&lt;/div&gt;`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                  }
                } catch(e) {
                  // Ignore parsing errors
                }
              }
            }

            readStream();
          }).catch(error => {
            if (error.name === 'AbortError') {
              streamingResponse.classList.remove('streaming');
              streamingResponse.innerHTML = `&lt;div class="text-yellow-400 text-sm"&gt;Generation stopped&lt;/div&gt;`;
            } else {
              streamingResponse.classList.remove('streaming');
              streamingResponse.innerHTML = `&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; Stream error: ${error.message}&lt;/div&gt;`;
            }
            resetSendButton();
          });
        }

        readStream();
      })
      .catch(error => {
        if (error.name === 'AbortError') {
          streamingResponse.classList.remove('streaming');
          streamingResponse.innerHTML = `&lt;div class="text-yellow-400 text-sm bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 mb-4"&gt; Generation stopped&lt;/div&gt;`;
        } else {
          streamingResponse.classList.remove('streaming');
          streamingResponse.innerHTML = `&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; Request failed: ${error.message}&lt;/div&gt;`;
        }
        resetSendButton();
      });

      messageInput.value = '';
      messageInput.style.height = '60px';
    }

    function resetSendButton() {
      sendBtn.classList.remove('hidden');
      stopBtn.classList.add('hidden');
      currentAbortController = null;
    }

    function stopGeneration() {
      if (currentAbortController) {
        currentAbortController.abort();
      }
    }

    function generateAssistantForLastUser(){
      const chat = chats.find(c => c.id === currentChatId);
      if(!chat) return;

      // Create streaming container for regeneration
      const streamingResponse = document.createElement('div');
      streamingResponse.className = 'assistant-response streaming';
      streamingResponse.innerHTML = '&lt;div class="text-sm text-indigo-300"&gt;Regenerating response...&lt;/div&gt;';
      chatBox.appendChild(streamingResponse);
      chatBox.scrollTop = chatBox.scrollHeight;

      const token = localStorage.getItem('gh_token');
      const selectedModelElement = document.getElementById('selectedModelName');
      const modelId = selectedModelElement?.dataset.modelId;
      const model = models.find(m => m.id === modelId);

      if(!token || !token.trim() || token.trim()=="" || token == "") {
        streamingResponse.classList.remove('streaming');
        streamingResponse.innerHTML = '&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; No authentication token found.&lt;/div&gt;';
        return;
      }

      if(!model || !model.id) {
        streamingResponse.classList.remove('streaming');
        streamingResponse.innerHTML = '&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; No valid model selected.&lt;/div&gt;';
        return;
      }

      // Initialize branches if needed
      if (!chat.branches) {
        chat.branches = [chat.messages || []];
        chat.currentBranch = 0;
        delete chat.messages;
      }

      let messages = [...chat.branches[chat.currentBranch]];
      const sys = document.getElementById('systemPromptText')?.value.trim();
      if(sys && (!messages[0] || messages[0].role !== 'system')) {
        messages.unshift({role: 'system', content: sys});
      }

      fetch('https://models.github.ai/inference/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          messages,
          model: model.id,
          stream: true
        })
      })
      .then(response => {
        if(!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullContent = '';

        function readStream() {
          reader.read().then(({done, value}) => {
            if(done) {
              streamingResponse.classList.remove('streaming');
              streamingResponse.innerHTML = `
                &lt;div class="markdown-body"&gt;${marked.parse(fullContent || '*No response received*')}&lt;/div&gt;
                &lt;div class="message-actions"&gt;
                  &lt;button class="action-btn" onclick="regenerateMessage(this)" title="Regenerate"&gt;
                    &lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;polyline points="23,4 23,10 17,10"&gt;&lt;/polyline&gt;
                      &lt;polyline points="1,20 1,14 7,14"&gt;&lt;/polyline&gt;
                      &lt;path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4-4.64,4.36A9,9,0,0,1,3.51,15"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                  &lt;/button&gt;
                  &lt;button class="action-btn" onclick="copyMessage(this)" title="Copy"&gt;
                    &lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;rect x="9" y="9" width="13" height="13" rx="2" ry="2"&gt;&lt;/rect&gt;
                      &lt;path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                  &lt;/button&gt;
                  &lt;button class="action-btn" onclick="deleteMessage(this)" title="Delete"&gt;
                    &lt;svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"&gt;
                      &lt;polyline points="3,6 5,6 21,6"&gt;&lt;/polyline&gt;
                      &lt;path d="m19,6v14c0,1-1,2-2,2H7c-1,0-2-1-2-2V6m3,0V4c0-1,1-2,2-2h4c1,0,2,1,2,2v2"&gt;&lt;/path&gt;
                    &lt;/svg&gt;
                  &lt;/button&gt;
                &lt;/div&gt;
              `;
              streamingResponse.dataset.role = 'assistant';

              if(fullContent) {
                const currentBranch = chat.branches[chat.currentBranch];
                currentBranch.push({role: 'assistant', content: fullContent});
                localStorage.setItem('chat_history', JSON.stringify(chats));
              }
              return;
            }

            const chunk = decoder.decode(value, {stream: true});
            const lines = chunk.split('\n').filter(line => line.trim() !== '');

            for(const line of lines) {
              if(line.startsWith('data: ')) {
                const data = line.slice(6);
                if(data === '[DONE]') {
                  return;
                }

                try {
                  const parsed = JSON.parse(data);
                  const content = parsed.choices?.[0]?.delta?.content || '';
                  if(content) {
                    fullContent += content;
                    streamingResponse.innerHTML = `&lt;div class="markdown-body"&gt;${marked.parse(fullContent)}&lt;/div&gt;`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                  }
                } catch(e) {
                  // Ignore parsing errors
                }
              }
            }

            readStream();
          }).catch(error => {
            if (error.name === 'AbortError') {
              streamingResponse.classList.remove('streaming');
              streamingResponse.innerHTML = `&lt;div class="text-yellow-400 text-sm"&gt;Generation stopped&lt;/div&gt;`;
            } else {
              streamingResponse.classList.remove('streaming');
              streamingResponse.innerHTML = `&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; Stream error: ${error.message}&lt;/div&gt;`;
            }
            resetSendButton();
          });
        }

        readStream();
      })
      .catch(error => {
        if (error.name === 'AbortError') {
          streamingResponse.classList.remove('streaming');
          streamingResponse.innerHTML = `&lt;div class="text-yellow-400 text-sm bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 mb-4"&gt; Generation stopped&lt;/div&gt;`;
        } else {
          streamingResponse.classList.remove('streaming');
          streamingResponse.innerHTML = `&lt;div class="text-red-400 text-sm bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-4"&gt; Request failed: ${error.message}&lt;/div&gt;`;
        }
        resetSendButton();
      });

      messageInput.value = '';
      messageInput.style.height = '60px';
    }

    // OAuth & Fetch
    const GITHUB_CLIENT_ID = 'Ov23li2MmzqUhjwLwwMB';
    const OAUTH_REDIRECT_URI = window.location.origin + window.location.pathname;

    function startOAuth(){
      if(location.protocol==='file:') { alert('Serve over http:// (not file://) for OAuth'); return; }
      const state = crypto.randomUUID();
      localStorage.setItem('oauth_state', state);
      const scope = 'read:user read:org models';
      const authUrl = `https://github.com/login/oauth/authorize?client_id=${encodeURIComponent(GITHUB_CLIENT_ID)}&redirect_uri=${encodeURIComponent(OAUTH_REDIRECT_URI)}&scope=${encodeURIComponent(scope)}&state=${encodeURIComponent(state)}`;
      window.location = authUrl;
    }

    function handleOAuthCallback(){
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      const state = params.get('state');
      if(!code) return;
      const expected = localStorage.getItem('oauth_state');
      if(!state || state !== expected){ alert('OAuth state mismatch. Retry sign in.'); return; }

      fetch(`${API_BASE}/api/exchange?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`)
        .then(r=>{ if(!r.ok) throw new Error('Exchange failed'); return r.json(); })
        .then(data=>{
          if(!data.access_token){ throw new Error('No access token in response'); }
          localStorage.setItem('gh_token', data.access_token);
          const octokit = new Octokit({ auth: data.access_token });
          history.replaceState({}, document.title, OAUTH_REDIRECT_URI);
          fetchModels(); loadUserProfile(); showChatPage();
        })
        .catch(err=>{ console.error(err); alert('OAuth exchange error: '+err.message); });
    }

    function fetchModels(){
      const token = localStorage.getItem('gh_token');
      if(!token || !token.trim() || token.trim()=="" || token == "") return;
      const statusEl = document.getElementById('networkStatus');

      // TODO: Add Cerebras models when external API keys are implemented
      // Cerebras offers better rate limits per model (especially for less used models like llama 70B)
      const fallback = [{"id":"openai/gpt-4.1","name":"OpenAI GPT-4.1","publisher":"OpenAI","summary":"gpt-4.1 outperforms gpt-4o across the board, with major gains in coding, instruction following, and long-context understanding","rate_limit_tier":"high","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-04-14","capabilities":["streaming","tool-calling"],"limits":{"max_input_tokens":1048576,"max_output_tokens":32768},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-4-1"},{"id":"openai/gpt-4.1-mini","name":"OpenAI GPT-4.1-mini","publisher":"OpenAI","summary":"gpt-4.1-mini outperform gpt-4o-mini across the board, with major gains in coding, instruction following, and long-context handling","rate_limit_tier":"low","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-04-14","capabilities":["streaming","tool-calling"],"limits":{"max_input_tokens":1048576,"max_output_tokens":32768},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-4-1-mini"},{"id":"openai/gpt-4.1-nano","name":"OpenAI GPT-4.1-nano","publisher":"OpenAI","summary":"gpt-4.1-nano provides gains in coding, instruction following, and long-context handling along with lower latency and cost","rate_limit_tier":"low","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-04-14","capabilities":["streaming","tool-calling"],"limits":{"max_input_tokens":1048576,"max_output_tokens":32768},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-4-1-nano"},{"id":"openai/gpt-4o","name":"OpenAI GPT-4o","publisher":"OpenAI","summary":"OpenAI's most advanced multimodal model in the gpt-4o family. Can handle both text and image inputs.","rate_limit_tier":"high","supported_input_modalities":["text","image","audio"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2024-11-20","capabilities":["agents","assistants","streaming","tool-calling"],"limits":{"max_input_tokens":131072,"max_output_tokens":16384},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-4o"},{"id":"openai/gpt-4o-mini","name":"OpenAI GPT-4o mini","publisher":"OpenAI","summary":"An affordable, efficient AI solution for diverse text and image tasks.","rate_limit_tier":"low","supported_input_modalities":["text","image","audio"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2024-07-18","capabilities":["agents","assistants","streaming","tool-calling"],"limits":{"max_input_tokens":131072,"max_output_tokens":4096},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-4o-mini"},{"id":"openai/gpt-5","name":"OpenAI gpt-5","publisher":"OpenAI","summary":"gpt-5 is designed for logic-heavy and multi-step tasks. ","rate_limit_tier":"custom","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-08-07","capabilities":["reasoning","tool-calling","streaming"],"limits":{"max_input_tokens":200000,"max_output_tokens":100000},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-5"},{"id":"openai/gpt-5-chat","name":"OpenAI gpt-5-chat (preview)","publisher":"OpenAI","summary":"gpt-5-chat (preview) is an advanced, natural, multimodal, and context-aware conversations for enterprise applications.","rate_limit_tier":"custom","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-08-07","capabilities":["reasoning","tool-calling","streaming"],"limits":{"max_input_tokens":200000,"max_output_tokens":100000},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-5-chat"},{"id":"openai/gpt-5-mini","name":"OpenAI gpt-5-mini","publisher":"OpenAI","summary":"gpt-5-mini is a lightweight version for cost-sensitive applications.","rate_limit_tier":"custom","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-08-07","capabilities":["reasoning","tool-calling","streaming"],"limits":{"max_input_tokens":200000,"max_output_tokens":100000},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-5-mini"},{"id":"openai/gpt-5-nano","name":"OpenAI gpt-5-nano","publisher":"OpenAI","summary":"gpt-5-nano is optimized for speed, ideal for applications requiring low latency. ","rate_limit_tier":"custom","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["multipurpose","multilingual","multimodal"],"registry":"azure-openai","version":"2025-08-07","capabilities":["reasoning","tool-calling","streaming"],"limits":{"max_input_tokens":200000,"max_output_tokens":100000},"html_url":"https://github.com/marketplace/models/azure-openai/gpt-5-nano"},{"id":"openai/o1","name":"OpenAI o1","publisher":"OpenAI","summary":"Focused on advanced reasoning and solving complex problems, including math and science tasks. Ideal for applications that require deep contextual understanding and agentic workflows.","rate_limit_tier":"custom","supported_input_modalities":["text","image"],"supported_output_modalities":["text"],"tags":["reasoning","multilingual","coding"],"registry":"azure-openai","version":"2024-12-17","capabilities":["reasoning","tool-calling"],"limits":{"max_input_tokens":200000,"max_output_tokens":100000},"html_url":"https://github.com/marketplace/models/azure-openai/o1"},{"id":"openai/o1-mini","name":"OpenAI o1-mini","publisher":"OpenAI","summary":"Smaller, faster, and 80% cheaper than o1-preview, performs well at code generation and small context operations.","rate_limit_tier":"custom","supported_input_modalities":["text"],"supported_output_modalities":["text"],"tags":["reasoning","multilingual","coding"],"registry":"azure-openai","version":"2024-09-12","capabilities":["reasoning","streaming"],"limits":{"max_input_tokens":128000,"max_output_tokens":65536},"html_url":"https://github.com/marketplace/models/azure-openai/o1-mini"}]
      fetch(`${API_BASE}/api/models`,{headers:{Authorization:`Bearer ${token}`}})
        .then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); })
        .then(data=>{
          models = Array.isArray(data)? data : (data.models||fallback);
          renderDropdownItems(models);
          renderTitleDropdownItems(models);

          // Restore previously selected model or select first available
          const savedModelId = localStorage.getItem('selected_model');
          const modelToSelect = savedModelId && models.find(m => m.id === savedModelId)
            ? savedModelId
            : (models.length ? models[0].id : null);

          if(modelToSelect) selectModel(modelToSelect);

          // Restore previously selected title model or select GPT-4.1 Mini as default
          const savedTitleModelId = localStorage.getItem('selected_title_model');
          const titleModelToSelect = savedTitleModelId && models.find(m => m.id === savedTitleModelId)
            ? savedTitleModelId
            : models.find(m => m.id === 'openai/gpt-4.1-mini')?.id || (models.length ? models[0].id : null);

          if(titleModelToSelect) selectTitleModel(titleModelToSelect);

          statusEl?.classList.add('hidden');
        })
        .catch(err=>{
          console.warn('Model fetch failed', err);
          models = fallback;
          renderDropdownItems(models);
          renderTitleDropdownItems(models);

          // Restore previously selected model or select first available
          const savedModelId = localStorage.getItem('selected_model');
          const modelToSelect = savedModelId && models.find(m => m.id === savedModelId)
            ? savedModelId
            : (models.length ? models[0].id : null);

          if(modelToSelect) selectModel(modelToSelect);

          // Restore previously selected title model or select GPT-4.1 Mini as default
          const savedTitleModelId = localStorage.getItem('selected_title_model');
          const titleModelToSelect = savedTitleModelId && models.find(m => m.id === savedTitleModelId)
            ? savedTitleModelId
            : models.find(m => m.id === 'openai/gpt-4.1-mini')?.id || (models.length ? models[0].id : null);

          if(titleModelToSelect) selectTitleModel(titleModelToSelect);

          if(statusEl){ statusEl.textContent = 'Using fallback models'; statusEl.classList.remove('hidden'); }
        });
    }

    document.getElementById('githubLogin')?.addEventListener('click', (e)=>{ e.preventDefault(); startOAuth(); });
    handleOAuthCallback();

    // Event Listeners
    sendBtn?.addEventListener('click', sendMessage);
    stopBtn?.addEventListener('click', stopGeneration);
    newChatBtn?.addEventListener('click', goToHomepage);


    // Mobile dropdown
    document.getElementById('mobileDropdownSelected')?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const mobileContent = document.getElementById('mobileDropdownContent');
      const mobileSelected = document.getElementById('mobileDropdownSelected');
      mobileContent?.classList.toggle('show');
      mobileSelected?.classList.toggle('active');
    });

    // Mobile hamburger menu
    document.getElementById('mobileMenuBtn')?.addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      sidebar?.classList.toggle('mobile-open');
    });

    dropdownSearch?.addEventListener('input', e => filterModels(e.target.value));
    document.getElementById('mobileDropdownSearch')?.addEventListener('input', e => filterModels(e.target.value));

    messageInput?.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        if(e.ctrlKey){ e.preventDefault(); sendMessage(); }
        else if(e.shiftKey){
          const start=messageInput.selectionStart;
          const end=messageInput.selectionEnd;
          messageInput.value=messageInput.value.substring(0,start)+'\n'+messageInput.value.substring(end);
          messageInput.selectionStart=messageInput.selectionEnd=start+1;
          // Auto-resize after adding newline
          setTimeout(() => {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
          }, 0);
          e.preventDefault();
        }
        else { e.preventDefault(); sendMessage(); }
      }
    });

    // Auto-resize textarea on input
    messageInput?.addEventListener('input', function(){
      this.style.height='auto';
      this.style.height=Math.min(this.scrollHeight, 200)+'px';
    });

    // Keyboard navigation
    let historyFocusIndex=-1;
    document.addEventListener('keydown', e=>{
      if(e.altKey && e.key==='n'){ e.preventDefault(); newChatBtn?.click(); }
      if(e.altKey && e.key==='m'){ e.preventDefault(); dropdownSelected?.click(); }
      if(e.altKey && e.key==='/'){ e.preventDefault(); messageInput?.focus(); }
      if(e.altKey && (e.key==='ArrowDown'||e.key==='ArrowUp')){
        e.preventDefault();
        const items=[...chatHistory.querySelectorAll('.chat-history-item')];
        if(!items.length) return;
        historyFocusIndex = e.key==='ArrowDown' ? (historyFocusIndex+1)%items.length : (historyFocusIndex-1+items.length)%items.length;
        items.forEach(i=>i.classList.remove('focused'));
        const t=items[historyFocusIndex];
        t.classList.add('focused');
        t.scrollIntoView({block:'nearest'});
        if(e.altKey&&e.shiftKey) t.click();
      }
    });

    // Initialize
    if (typeof hljs !== 'undefined') {
      hljs.highlightAll();
    }

    loadChatHistory();
    if(!chats.length) createNewChat();
  })();
  </script>
</body>
</html>
